// Daily Trend Chart
        function updateDailyTrendChart() {
            const ctx = document.getElementById('dailyTrendChart').getContext('2d');
            
            if (analyticsCharts.dailyTrend) {
                analyticsCharts.dailyTrend.destroy();
            }

            // Group data by date
            const dailyData = {};
            filteredTables.forEach(table => {
                const date = new Date(table.visitDate || table.date).toDateString();
                if (!dailyData[date]) {
                    dailyData[date] = 0;
                }
                dailyData[date] += parseFloat(table.totalBill || 0);
            });

            // Sort dates
            const sortedDates = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
            const labels = sortedDates.map(date => new Date(date).toLocaleDateString('th-TH', { month: 'short', day: 'numeric' }));
            const data = sortedDates.map(date => dailyData[date]);
            const totalRevenue = data.reduce((sum, value) => sum + value, 0);

            analyticsCharts.dailyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ยอดขายรายวัน (฿)',
                        data: data,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '฿' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const percentage = totalRevenue > 0 ? ((value / totalRevenue) * 100).toFixed(1) : 0;
                                    return `ยอดขาย: ฿${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issho Izakaya - ระบบบันทึกข้อมูลลูกค้า (Google Sheets)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            padding: 50px 40px;
            text-align: center;
            max-width: 450px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        
        .welcome-screen {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 60px 40px;
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        
        .logo-icon {
            width: 80px;
            height: 80px;
            background: #dc3545;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.3);
        }
        
        .main-app {
            display: none;
            padding: 20px 0;
        }
        
        .navbar-custom {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-custom {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .btn-custom {
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom {
            background: linear-gradient(45deg, #dc3545, #e85a6a);
            border: none;
            color: white;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
            color: white;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }
        
        .form-control:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .customer-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .customer-card.filled {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-color: #dc3545;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.2);
        }
        
        .customer-card-header {
            background: linear-gradient(45deg, #dc3545, #e85a6a);
            color: white;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .customer-number {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .remove-customer {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .remove-customer:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .form-section {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-header {
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dc3545;
        }
        
        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
        }
        
        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            color: #6c757d;
            font-weight: 600;
        }
        
        .nav-tabs .nav-link.active {
            background: #dc3545;
            color: white;
        }
        
        .analytics-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .analytics-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
            font-weight: 500;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .status-online {
            background: #28a745;
            color: white;
        }

        .status-offline {
            background: #ffc107;
            color: #212529;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        .settings-card {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .login-icon {
            width: 60px;
            height: 60px;
            background: #dc3545;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }

        .form-floating {
            margin-bottom: 20px;
        }

        .form-floating label {
            color: #6c757d;
        }

        .btn-logout {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .password-modal .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .password-modal .modal-header {
            background: linear-gradient(45deg, #dc3545, #e85a6a);
            color: white;
            border-radius: 15px 15px 0 0;
            border: none;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* แก้ไข Container ให้อยู่กลาง */
        .container-center {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .form-container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* ปรับแต่งการจัดวาง */
        .customer-form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .customer-form-row > div {
            flex: 1;
        }

        @media (max-width: 768px) {
            .customer-form-row {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-icon">
                <i class="fas fa-lock text-white" style="font-size: 1.5rem;"></i>
            </div>
            <h2 class="h3 mb-3" style="color: #dc3545; font-weight: bold;">เข้าสู่ระบบ</h2>
            <p class="text-muted mb-4">กรุณาใส่ชื่อผู้ใช้และรหัสผ่าน</p>
            
            <form id="loginForm">
                <div class="form-floating">
                    <input type="text" class="form-control" id="username" placeholder="ชื่อผู้ใช้" required>
                    <label for="username"><i class="fas fa-user me-2"></i>ชื่อผู้ใช้</label>
                </div>
                
                <div class="form-floating">
                    <input type="password" class="form-control" id="password" placeholder="รหัสผ่าน" required>
                    <label for="password"><i class="fas fa-key me-2"></i>รหัสผ่าน</label>
                </div>
                
                <div id="loginError" class="alert alert-danger d-none">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง
                </div>
                
                <button type="submit" class="btn btn-primary-custom btn-custom w-100">
                    <i class="fas fa-sign-in-alt me-2"></i>เข้าสู่ระบบ
                </button>
            </form>
            
            <div class="mt-4">
                <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    ระบบปลอดภัยด้วยการเข้ารหัส
                </small>
            </div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-card">
            <button class="btn btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i>ออกจากระบบ
            </button>
            <div class="logo-icon">
                <i class="fas fa-utensils text-white" style="font-size: 2rem;"></i>
            </div>
            <h1 class="h2 mb-3" style="color: #dc3545; font-weight: bold;">Issho Izakaya</h1>
            <p class="text-muted mb-4">ระบบบันทึกข้อมูลลูกค้าแบบโต๊ะ<br>เชื่อมต่อกับ Google Sheets</p>
            <button class="btn btn-primary-custom btn-custom" onclick="startApp()">
                <i class="fas fa-play me-2"></i>เริ่มใช้งาน
            </button>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-cloud me-1"></i>
                    ข้อมูลจะถูกบันทึกใน Google Sheets
                </small>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status-offline" style="display: none;">
        <i class="fas fa-wifi me-2"></i>
        <span id="statusText">กำลังเชื่อมต่อ...</span>
    </div>

    <!-- Password Confirmation Modal -->
    <div class="modal fade password-modal" id="passwordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-shield-alt me-2"></i>ยืนยันการลบข้อมูล
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h6 class="text-center mb-3">คุณต้องการลบข้อมูลทั้งหมดในเครื่องหรือไม่?</h6>
                    <p class="text-center text-muted mb-4">การดำเนินการนี้ไม่สามารถย้อนกลับได้<br>ข้อมูลใน Google Sheets จะไม่ถูกลบ</p>
                    
                    <div class="form-floating">
                        <input type="password" class="form-control" id="confirmPassword" placeholder="รหัสผ่าน">
                        <label for="confirmPassword"><i class="fas fa-key me-2"></i>กรุณาใส่รหัสผ่านเพื่อยืนยัน</label>
                    </div>
                    
                    <div id="passwordError" class="alert alert-danger d-none mt-3">
                        <i class="fas fa-times-circle me-2"></i>รหัสผ่านไม่ถูกต้อง
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>ยกเลิก
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmClearData()">
                        <i class="fas fa-trash me-2"></i>ลบข้อมูล
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light navbar-custom fixed-top">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-utensils text-danger me-2"></i>
                    <strong style="color: #dc3545;">Issho Izakaya</strong>
                </a>
                <div class="d-flex align-items-center">
                    <span class="navbar-text me-3">
                        <i class="fas fa-calendar-alt me-1"></i>
                        <span id="currentDate"></span>
                    </span>
                    <span class="navbar-text me-3">
                        <i class="fas fa-clock me-1"></i>
                        <span id="currentTime"></span>
                    </span>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i>ออกจากระบบ
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-center" style="margin-top: 100px;">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Stats Dashboard -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalTables">0</div>
                        <div>โต๊ะทั้งหมด</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalCustomers">0</div>
                        <div>ลูกค้าทั้งหมด</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalRevenue">0</div>
                        <div>ยอดขายรวม (฿)</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="avgPerHead">0</div>
                        <div>เฉลี่ยต่อหัว (฿)</div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="add-table-tab" data-bs-toggle="tab" data-bs-target="#add-table" type="button" role="tab">
                        <i class="fas fa-plus me-2"></i>บันทึกโต๊ะใหม่
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="table-list-tab" data-bs-toggle="tab" data-bs-target="#table-list" type="button" role="tab">
                        <i class="fas fa-list me-2"></i>รายการโต๊ะ
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>วิเคราะห์ข้อมูล
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                        <i class="fas fa-cog me-2"></i>ตั้งค่า
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabContent">
                <!-- Add Table Tab -->
                <div class="tab-pane fade show active" id="add-table" role="tabpanel">
                    <div class="form-container">
                        <div class="card card-custom">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0 text-center"><i class="fas fa-plus me-2 text-danger"></i>บันทึกข้อมูลโต๊ะใหม่</h5>
                            </div>
                            <div class="card-body">
                                <form id="tableForm">
                                    <!-- ข้อมูลโต๊ะ -->
                                    <div class="form-section">
                                        <h6 class="section-header"><i class="fas fa-table me-2"></i>ข้อมูลโต๊ะ</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">วันที่เข้าใช้บริการ *</label>
                                                <input type="date" class="form-control" id="visitDate" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">หมายเลขโต๊ะ (Auto)</label>
                                                <input type="text" class="form-control" id="tableNumber" placeholder="จะสร้างอัตโนมัติ" readonly style="background-color: #f8f9fa;">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">กลุ่มลูกค้า *</label>
                                                <select class="form-control" id="customerGroup" required>
                                                    <option value="">เลือกกลุ่ม</option>
                                                    <option value="คนเดียว">คนเดียว</option>
                                                    <option value="คู่รัก">คู่รัก</option>
                                                    <option value="กลุ่มเพื่อน">กลุ่มเพื่อน</option>
                                                    <option value="ครอบครัว">ครอบครัว</option>
                                                    <option value="องค์กร/บริษัท">องค์กร/บริษัท</option>
                                                    <option value="นักท่องเที่ยว">นักท่องเที่ยว</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">ยอดขายรวม (฿) *</label>
                                                <input type="number" class="form-control" id="totalBill" min="0" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- รายละเอียดเพิ่มเติม -->
                                    <div class="form-section">
                                        <h6 class="section-header"><i class="fas fa-info-circle me-2"></i>รายละเอียดเพิ่มเติม</h6>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">เวลาเข้าใช้บริการ *</label>
                                                <select class="form-control" id="visitTime" required>
                                                    <option value="">เลือกช่วงเวลา</option>
                                                    <option value="11:00-12:00">11:00-12:00 น.</option>
                                                    <option value="12:00-13:00">12:00-13:00 น.</option>
                                                    <option value="13:00-14:00">13:00-14:00 น.</option>
                                                    <option value="14:00-15:00">14:00-15:00 น.</option>
                                                    <option value="15:00-16:00">15:00-16:00 น.</option>
                                                    <option value="16:00-17:00">16:00-17:00 น.</option>
                                                    <option value="17:00-18:00">17:00-18:00 น.</option>
                                                    <option value="18:00-19:00">18:00-19:00 น.</option>
                                                    <option value="19:00-20:00">19:00-20:00 น.</option>
                                                    <option value="20:00-21:00">20:00-21:00 น.</option>
                                                    <option value="21:00-22:00">21:00-22:00 น.</option>
                                                    <option value="22:00-23:00">22:00-23:00 น.</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">วิธีการชำระเงิน</label>
                                                <select class="form-control" id="paymentMethod">
                                                    <option value="เงินสด">เงินสด</option>
                                                    <option value="บัตรเครดิต">บัตรเครดิต</option>
                                                    <option value="QR Code">QR Code</option>
                                                    <option value="โอนเงิน">โอนเงิน</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">โอกาสพิเศษ</label>
                                                <select class="form-control" id="occasion">
                                                    <option value="">เลือกโอกาสพิเศษ</option>
                                                    <option value="วันเกิด">วันเกิด</option>
                                                    <option value="ครบรอบ">ครบรอบ</option>
                                                    <option value="ปาร์ตี้">ปาร์ตี้</option>
                                                    <option value="ประชุมงาน">ประชุมงาน</option>
                                                    <option value="วันหยุด">วันหยุด</option>
                                                    <option value="ทานมื้อเย็น">ทานมื้อเย็น</option>
                                                    <option value="นั่งชิล">นั่งชิล</option>
                                                    <option value="อื่นๆ">อื่นๆ</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- รายละเอียดลูกค้าในโต๊ะ -->
                                    <div class="form-section">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="section-header mb-0"><i class="fas fa-users me-2"></i>รายละเอียดลูกค้าในโต๊ะ</h6>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCustomer()">
                                                <i class="fas fa-plus me-1"></i>เพิ่มลูกค้า
                                            </button>
                                        </div>

                                        <div id="customersContainer">
                                            <!-- Customer cards will be added here -->
                                        </div>
                                    </div>

                                    <!-- ความพึงพอใจและหมายเหตุ -->
                                    <div class="form-section">
                                        <h6 class="section-header"><i class="fas fa-star me-2"></i>ความพึงพอใจและหมายเหตุ</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">ระดับความพึงพอใจ</label>
                                                <select class="form-control" id="satisfaction">
                                                    <option value="">เลือกระดับ</option>
                                                    <option value="5">★★★★★ ดีเยี่ยม</option>
                                                    <option value="4">★★★★☆ ดี</option>
                                                    <option value="3">★★★☆☆ ปานกลาง</option>
                                                    <option value="2">★★☆☆☆ พอใช้</option>
                                                    <option value="1">★☆☆☆☆ ต้องปรับปรุง</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">หมายเหตุเพิ่มเติม</label>
                                                <textarea class="form-control" id="notes" rows="3" placeholder="ข้อมูลเพิ่มเติม, ปัญหาที่พบ, ข้อเรียกร้องพิเศษ, คำแนะนำจากลูกค้า"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="text-center">
                                        <button type="button" class="btn btn-secondary me-3" onclick="resetForm()">
                                            <i class="fas fa-undo me-2"></i>ล้างข้อมูล
                                        </button>
                                        <button type="submit" class="btn btn-primary-custom" id="submitBtn">
                                            <i class="fas fa-save me-2"></i>บันทึกข้อมูล
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table List Tab -->
                <div class="tab-pane fade" id="table-list" role="tabpanel">
                    <div class="card card-custom">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2 text-danger"></i>รายการโต๊ะ</h5>
                            <div class="d-flex">
                                <button class="btn btn-outline-primary me-2" onclick="loadDataFromSheets()">
                                    <i class="fas fa-sync-alt me-2"></i>โหลดข้อมูลใหม่
                                </button>
                                <input type="text" class="form-control" id="searchTable" placeholder="ค้นหาโต๊ะ..." style="width: 250px;">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>วันที่</th>
                                            <th>โต๊ะ</th>
                                            <th>กลุ่มลูกค้า</th>
                                            <th>จำนวนคน</th>
                                            <th>ยอดขาย</th>
                                            <th>เฉลี่ย/หัว</th>
                                            <th>เวลา</th>
                                            <th>พึงพอใจ</th>
                                            <th>จัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableListBody">
                                        <!-- Table data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <!-- Control Panel -->
                    <div class="card card-custom mb-4">
                        <div class="card-header bg-transparent">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2 text-danger"></i>Dashboard วิเคราะห์ข้อมูล</h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="syncAnalyticsData()">
                                        <i class="fas fa-sync me-2"></i>Sync ข้อมูล
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="exportToCSV()">
                                        <i class="fas fa-download me-2"></i>ส่งออก CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filters -->
                            <div class="row mb-4">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">ช่วงวันที่</label>
                                    <select class="form-control" id="dateRangeFilter" onchange="applyFilters()">
                                        <option value="all">ทั้งหมด</option>
                                        <option value="today">วันนี้</option>
                                        <option value="week">7 วันที่ผ่านมา</option>
                                        <option value="month">30 วันที่ผ่านมา</option>
                                        <option value="custom">กำหนดเอง</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">วันในสัปดาห์</label>
                                    <select class="form-control" id="dayOfWeekFilter" onchange="applyFilters()">
                                        <option value="all">ทุกวัน</option>
                                        <option value="1">วันจันทร์</option>
                                        <option value="2">วันอังคาร</option>
                                        <option value="3">วันพุธ</option>
                                        <option value="4">วันพฤหัสบดี</option>
                                        <option value="5">วันศุกร์</option>
                                        <option value="6">วันเสาร์</option>
                                        <option value="0">วันอาทิตย์</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">ช่วงเวลา</label>
                                    <select class="form-control" id="timeSlotFilter" onchange="applyFilters()">
                                        <option value="all">ทุกช่วงเวลา</option>
                                        <option value="morning">เช้า (11:00-14:00)</option>
                                        <option value="afternoon">บ่าย (14:00-17:00)</option>
                                        <option value="evening">เย็น (17:00-20:00)</option>
                                        <option value="night">กลางคืน (20:00-23:00)</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">กลุ่มลูกค้า</label>
                                    <select class="form-control" id="customerGroupFilter" onchange="applyFilters()">
                                        <option value="all">ทุกกลุ่ม</option>
                                        <option value="คนเดียว">คนเดียว</option>
                                        <option value="คู่รัก">คู่รัก</option>
                                        <option value="กลุ่มเพื่อน">กลุ่มเพื่อน</option>
                                        <option value="ครอบครัว">ครอบครัว</option>
                                        <option value="องค์กร/บริษัท">องค์กร/บริษัท</option>
                                        <option value="นักท่องเที่ยว">นักท่องเที่ยว</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Custom Date Range -->
                            <div class="row mb-3" id="customDateRange" style="display: none;">
                                <div class="col-md-6">
                                    <label class="form-label">วันที่เริ่มต้น</label>
                                    <input type="date" class="form-control" id="startDate" onchange="applyFilters()">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">วันที่สิ้นสุด</label>
                                    <input type="date" class="form-control" id="endDate" onchange="applyFilters()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Metrics -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <div class="analytics-card">
                                <div class="analytics-number" id="totalTablesAnalytics">0</div>
                                <div>จำนวนโต๊ะ</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="analytics-card">
                                <div class="analytics-number" id="totalCustomersAnalytics">0</div>
                                <div>จำนวนลูกค้า</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="analytics-number" id="totalRevenueAnalytics">0</div>
                                <div>ยอดขายรวม (฿)</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="analytics-card">
                                <div class="analytics-number" id="avgPerHeadAnalytics">0</div>
                                <div>เฉลี่ยต่อหัว (฿)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="analytics-number" id="avgPerBillAnalytics">0</div>
                                <div>เฉลี่ยต่อบิล (฿)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 1 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-transparent">
                                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2 text-danger"></i>สัดส่วนกลุ่มลูกค้า</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="customerGroupChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-transparent">
                                    <h6 class="mb-0"><i class="fas fa-venus-mars me-2 text-danger"></i>สัดส่วนเพศ</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="genderChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 2 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-transparent">
                                    <h6 class="mb-0"><i class="fas fa-clock me-2 text-danger"></i>ยอดขายตามช่วงเวลา</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="timeSlotRevenueChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-transparent">
                                    <h6 class="mb-0"><i class="fas fa-calendar-week me-2 text-danger"></i>ยอดขายตามวันในสัปดาห์</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="dayOfWeekRevenueChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 3 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-transparent">
                                    <h6 class="mb-0"><i class="fas fa-users me-2 text-danger"></i>จำนวนลูกค้าตามช่วงอายุ</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="ageGroupChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-transparent">
                                    <h6 class="mb-0"><i class="fas fa-chart-line me-2 text-danger"></i>เทรนด์ยอดขายรายวัน</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="dailyTrendChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Table -->
                    <div class="card card-custom mb-4">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0"><i class="fas fa-table me-2 text-danger"></i>ตารางวิเคราะห์รายละเอียด</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="analyticsDetailTable">
                                    <thead>
                                        <tr>
                                            <th>กลุ่มลูกค้า</th>
                                            <th>จำนวนโต๊ะ</th>
                                            <th>จำนวนคน</th>
                                            <th>ยอดขายรวม</th>
                                            <th>เฉลี่ยต่อบิล</th>
                                            <th>เฉลี่ยต่อหัว</th>
                                            <th>% ของยอดขาย</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analyticsDetailTableBody">
                                        <!-- Analytics detail will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <div class="card card-custom">
                        <div class="card-header bg-transparent">
                            <h5 class="mb-0"><i class="fas fa-cog me-2 text-danger"></i>ตั้งค่าระบบ</h5>
                        </div>
                        <div class="card-body">
                            <div class="settings-card">
                                <h6><i class="fas fa-link me-2"></i>การเชื่อมต่อ Google Sheets</h6>
                                <div class="row mt-3">
                                    <div class="col-md-8 mb-3">
                                        <label class="form-label text-white">Google Apps Script URL</label>
                                        <input type="url" class="form-control" id="scriptUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                                    </div>
                                    <div class="col-md-4 mb-3 d-flex align-items-end">
                                        <button class="btn btn-light w-100" onclick="saveSettings()">
                                            <i class="fas fa-save me-2"></i>บันทึกการตั้งค่า
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-light">
                                        <i class="fas fa-info-circle me-1"></i>
                                        URL ที่ได้จากการ Deploy Google Apps Script
                                    </small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-test-tube me-2"></i>ทดสอบการเชื่อมต่อ</h6>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-outline-primary w-100 mb-2" onclick="testConnection()">
                                                <i class="fas fa-plug me-2"></i>ทดสอบการเชื่อมต่อ
                                            </button>
                                            <button class="btn btn-outline-success w-100" onclick="loadDataFromSheets()">
                                                <i class="fas fa-download me-2"></i>โหลดข้อมูลจาก Sheets
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-database me-2"></i>จัดการข้อมูล</h6>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-outline-warning w-100 mb-2" onclick="showClearDataModal()">
                                                <i class="fas fa-broom me-2"></i>ล้างข้อมูลในเครื่อง
                                            </button>
                                            <button class="btn btn-outline-info w-100" onclick="syncData()">
                                                <i class="fas fa-sync me-2"></i>ซิงค์ข้อมูล
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-4">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>วิธีการตั้งค่า Google Sheets</h6>
                                </div>
                                <div class="card-body">
                                    <ol class="mb-3">
                                        <li class="mb-2">สร้าง Google Sheets ใหม่และตั้งชื่อคอลัมน์ตามที่กำหนด</li>
                                        <li class="mb-2">เปิด Extensions > Apps Script</li>
                                        <li class="mb-2">วาง Code ด้านล่างและ Deploy เป็น Web App</li>
                                        <li class="mb-2">ตั้งค่า: Execute as "Me", Access to "Anyone"</li>
                                        <li class="mb-2">คัดลอก URL ที่ได้มาใส่ในช่องด้านบน</li>
                                        <li>ทดสอบการเชื่อมต่อ</li>
                                    </ol>
                                    
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-code me-2"></i>Google Apps Script Code ที่ใช้:</h6>
                                        <pre class="mt-2" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 0.9rem; overflow-x: auto;">
<code>function doGet(e) {
  try {
    const action = e.parameter.action;
    const test = e.parameter.test;
    
    if (test) {
      return ContentService.createTextOutput(JSON.stringify({
        status: "success",
        message: "Connection test successful"
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    if (action === 'getData') {
      const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
      const data = sheet.getDataRange().getValues();
      
      if (data.length <= 1) {
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          data: [],
          message: "No data found"
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      const headers = data[0];
      const tables = [];
      
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const table = {};
        
        headers.forEach((header, index) => {
          table[header] = row[index];
        });
        
        // Parse customers data if exists
        if (table.customers && typeof table.customers === 'string') {
          try {
            table.customers = JSON.parse(table.customers);
          } catch (e) {
            table.customers = [];
          }
        }
        
        tables.push(table);
      }
      
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        data: tables,
        message: `Loaded ${tables.length} records`
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      error: "Invalid action"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // Check if headers exist
    const lastRow = sheet.getLastRow();
    if (lastRow === 0) {
      // Add headers
      const headers = [
        'id', 'date', 'visitDate', 'tableNumber', 'customerGroup', 
        'totalBill', 'visitTime', 'paymentMethod', 'occasion', 
        'satisfaction', 'notes', 'customers'
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    }
    
    // Add data
    const row = [
      data.id,
      data.date,
      data.visitDate,
      data.tableNumber,
      data.customerGroup,
      data.totalBill,
      data.visitTime,
      data.paymentMethod,
      data.occasion,
      data.satisfaction,
      data.notes,
      JSON.stringify(data.customers)
    ];
    
    sheet.appendRow(row);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: "Data saved successfully"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script>
        // Global variables
        let tables = [];
        let filteredTables = [];
        let customerCounter = 0;
        let isLoggedIn = false;
        let analyticsCharts = {};
        const VALID_USERNAME = 'issho';
        const VALID_PASSWORD = 'issho2323';

        // Sync analytics data from Google Sheets
        async function syncAnalyticsData() {
            try {
                updateConnectionStatus('loading');
                
                if (googleAPI.scriptUrl) {
                    console.log('Syncing data from Google Sheets...');
                    
                    // Try to load data from Google Sheets
                    const result = await googleAPI.loadData();
                    console.log('Google Sheets result:', result);
                    
                    if (result.success && result.data && result.data.length > 0) {
                        // Use Google Sheets data as primary source
                        filteredTables = result.data;
                        
                        // Also merge with local data to avoid losing recent entries
                        const mergedData = [...result.data];
                        tables.forEach(localTable => {
                            const exists = result.data.find(sheetTable => 
                                Math.abs(new Date(sheetTable.visitDate) - new Date(localTable.visitDate)) < 86400000 && // same day
                                sheetTable.tableNumber === localTable.tableNumber &&
                                Math.abs(sheetTable.totalBill - localTable.totalBill) < 0.01 // same bill amount
                            );
                            
                            if (!exists) {
                                mergedData.push(localTable);
                            }
                        });
                        
                        filteredTables = mergedData;
                        showSuccessAlert(`ซิงค์สำเร็จ! แสดงข้อมูล ${mergedData.length} โต๊ะ (${result.data.length} จาก Google Sheets)`);
                    } else {
                        // Use only local data
                        filteredTables = [...tables];
                        showWarningAlert(`ใช้ข้อมูลในเครื่อง ${tables.length} โต๊ะ - ${result.message || 'ไม่พบข้อมูลใน Google Sheets'}`);
                    }
                } else {
                    filteredTables = [...tables];
                    showWarningAlert('ยังไม่ได้ตั้งค่า Google Sheets URL - ใช้ข้อมูลในเครื่อง');
                }
                
                console.log('Filtered tables:', filteredTables.length);
                applyFilters();
                
            } catch (error) {
                console.error('Sync error:', error);
                filteredTables = [...tables];
                showErrorAlert(`Error: ${error.message} - ใช้ข้อมูลในเครื่อง ${tables.length} โต๊ะ`);
                applyFilters();
            }
        }

        // Apply filters to data
        function applyFilters() {
            const dateRange = document.getElementById('dateRangeFilter').value;
            const dayOfWeek = document.getElementById('dayOfWeekFilter').value;
            const timeSlot = document.getElementById('timeSlotFilter').value;
            const customerGroup = document.getElementById('customerGroupFilter').value;
            
            // Show/hide custom date range
            const customDateRange = document.getElementById('customDateRange');
            if (dateRange === 'custom') {
                customDateRange.style.display = 'flex';
            } else {
                customDateRange.style.display = 'none';
            }

            // Start with all tables
            filteredTables = [...tables];

            // Apply date range filter
            if (dateRange !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                filteredTables = filteredTables.filter(table => {
                    const tableDate = new Date(table.visitDate || table.date);
                    const tableDateOnly = new Date(tableDate.getFullYear(), tableDate.getMonth(), tableDate.getDate());
                    
                    switch (dateRange) {
                        case 'today':
                            return tableDateOnly.getTime() === today.getTime();
                        case 'week':
                            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return tableDateOnly >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                            return tableDateOnly >= monthAgo;
                        case 'custom':
                            const startDate = document.getElementById('startDate').value;
                            const endDate = document.getElementById('endDate').value;
                            if (startDate && endDate) {
                                const start = new Date(startDate);
                                const end = new Date(endDate);
                                return tableDateOnly >= start && tableDateOnly <= end;
                            }
                            return true;
                        default:
                            return true;
                    }
                });
            }

            // Apply day of week filter
            if (dayOfWeek !== 'all') {
                filteredTables = filteredTables.filter(table => {
                    const tableDate = new Date(table.visitDate || table.date);
                    return tableDate.getDay().toString() === dayOfWeek;
                });
            }

            // Apply time slot filter
            if (timeSlot !== 'all') {
                filteredTables = filteredTables.filter(table => {
                    const visitTime = table.visitTime;
                    if (!visitTime) return false;
                    
                    const hour = parseInt(visitTime.split(':')[0]);
                    switch (timeSlot) {
                        case 'morning':
                            return hour >= 11 && hour < 14;
                        case 'afternoon':
                            return hour >= 14 && hour < 17;
                        case 'evening':
                            return hour >= 17 && hour < 20;
                        case 'night':
                            return hour >= 20 && hour < 23;
                        default:
                            return true;
                    }
                });
            }

            // Apply customer group filter
            if (customerGroup !== 'all') {
                filteredTables = filteredTables.filter(table => table.customerGroup === customerGroup);
            }

            // Update analytics display
            updateAnalyticsDisplay();
        }

        // Update analytics display with filtered data
        function updateAnalyticsDisplay() {
            updateAnalyticsMetrics();
            updateAnalyticsCharts();
            updateAnalyticsDetailTable();
        }

        // Update analytics metrics
        function updateAnalyticsMetrics() {
            const totalTables = filteredTables.length;
            const totalCustomers = filteredTables.reduce((sum, table) => sum + table.customers.length, 0);
            const totalRevenue = filteredTables.reduce((sum, table) => sum + parseFloat(table.totalBill || 0), 0);
            const avgPerHead = totalCustomers > 0 ? totalRevenue / totalCustomers : 0;
            const avgPerBill = totalTables > 0 ? totalRevenue / totalTables : 0;

            document.getElementById('totalTablesAnalytics').textContent = totalTables.toLocaleString();
            document.getElementById('totalCustomersAnalytics').textContent = totalCustomers.toLocaleString();
            document.getElementById('totalRevenueAnalytics').textContent = totalRevenue.toLocaleString();
            document.getElementById('avgPerHeadAnalytics').textContent = Math.round(avgPerHead).toLocaleString();
            document.getElementById('avgPerBillAnalytics').textContent = Math.round(avgPerBill).toLocaleString();
        }

        // Update all analytics charts
        function updateAnalyticsCharts() {
            updateCustomerGroupChart();
            updateGenderChart();
            updateTimeSlotRevenueChart();
            updateDayOfWeekRevenueChart();
            updateAgeGroupChart();
            updateDailyTrendChart();
        }

        // Customer Group Pie Chart
        function updateCustomerGroupChart() {
            const ctx = document.getElementById('customerGroupChart').getContext('2d');
            
            // Destroy existing chart
            if (analyticsCharts.customerGroup) {
                analyticsCharts.customerGroup.destroy();
            }

            // Calculate data
            const groupData = {};
            filteredTables.forEach(table => {
                const group = table.customerGroup || 'ไม่ระบุ';
                groupData[group] = (groupData[group] || 0) + 1;
            });

            const labels = Object.keys(groupData);
            const data = Object.values(groupData);
            const total = data.reduce((sum, value) => sum + value, 0);
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];

            analyticsCharts.customerGroup = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} โต๊ะ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gender Pie Chart
        function updateGenderChart() {
            const ctx = document.getElementById('genderChart').getContext('2d');
            
            if (analyticsCharts.gender) {
                analyticsCharts.gender.destroy();
            }

            const genderData = {};
            filteredTables.forEach(table => {
                table.customers.forEach(customer => {
                    const gender = customer.gender || 'ไม่ระบุ';
                    genderData[gender] = (genderData[gender] || 0) + 1;
                });
            });

            const labels = Object.keys(genderData);
            const data = Object.values(genderData);
            const total = data.reduce((sum, value) => sum + value, 0);
            const colors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF'];

            analyticsCharts.gender = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} คน (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Time Slot Revenue Chart
        function updateTimeSlotRevenueChart() {
            const ctx = document.getElementById('timeSlotRevenueChart').getContext('2d');
            
            if (analyticsCharts.timeSlotRevenue) {
                analyticsCharts.timeSlotRevenue.destroy();
            }

            const timeSlots = [
                '11:00-12:00', '12:00-13:00', '13:00-14:00', '14:00-15:00',
                '15:00-16:00', '16:00-17:00', '17:00-18:00', '18:00-19:00',
                '19:00-20:00', '20:00-21:00', '21:00-22:00', '22:00-23:00'
            ];

            const revenueData = {};
            timeSlots.forEach(slot => revenueData[slot] = 0);

            filteredTables.forEach(table => {
                const timeSlot = table.visitTime;
                if (timeSlot && revenueData.hasOwnProperty(timeSlot)) {
                    revenueData[timeSlot] += parseFloat(table.totalBill || 0);
                }
            });

            const totalRevenue = Object.values(revenueData).reduce((sum, value) => sum + value, 0);

            analyticsCharts.timeSlotRevenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: timeSlots,
                    datasets: [{
                        label: 'ยอดขาย (฿)',
                        data: Object.values(revenueData),
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '฿' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const percentage = totalRevenue > 0 ? ((value / totalRevenue) * 100).toFixed(1) : 0;
                                    return `ยอดขาย: ฿${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Day of Week Revenue Chart
        function updateDayOfWeekRevenueChart() {
            const ctx = document.getElementById('dayOfWeekRevenueChart').getContext('2d');
            
            if (analyticsCharts.dayOfWeekRevenue) {
                analyticsCharts.dayOfWeekRevenue.destroy();
            }

            const days = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];
            const revenueData = [0, 0, 0, 0, 0, 0, 0];

            filteredTables.forEach(table => {
                const tableDate = new Date(table.visitDate || table.date);
                const dayOfWeek = tableDate.getDay();
                revenueData[dayOfWeek] += parseFloat(table.totalBill || 0);
            });

            const totalRevenue = revenueData.reduce((sum, value) => sum + value, 0);

            analyticsCharts.dayOfWeekRevenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'ยอดขาย (฿)',
                        data: revenueData,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '฿' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const percentage = totalRevenue > 0 ? ((value / totalRevenue) * 100).toFixed(1) : 0;
                                    return `ยอดขาย: ฿${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Age Group Chart
        function updateAgeGroupChart() {
            const ctx = document.getElementById('ageGroupChart').getContext('2d');
            
            if (analyticsCharts.ageGroup) {
                analyticsCharts.ageGroup.destroy();
            }

            const ageGroups = ['0-12', '13-17', '18-25', '26-35', '36-45', '46-55', '56-65', '66+'];
            const ageData = {};
            ageGroups.forEach(age => ageData[age] = 0);

            filteredTables.forEach(table => {
                table.customers.forEach(customer => {
                    const age = customer.age;
                    if (age && ageData.hasOwnProperty(age)) {
                        ageData[age]++;
                    }
                });
            });

            const totalCustomers = Object.values(ageData).reduce((sum, value) => sum + value, 0);

            analyticsCharts.ageGroup = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ageGroups.map(age => age + ' ปี'),
                    datasets: [{
                        label: 'จำนวนลูกค้า',
                        data: Object.values(ageData),
                        backgroundColor: 'rgba(255, 206, 86, 0.7)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const percentage = totalCustomers > 0 ? ((value / totalCustomers) * 100).toFixed(1) : 0;
                                    return `จำนวน: ${value} คน (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Daily Trend Chart
        function updateDailyTrendChart() {
            const ctx = document.getElementById('dailyTrendChart').getContext('2d');
            
            if (analyticsCharts.dailyTrend) {
                analyticsCharts.dailyTrend.destroy();
            }

            // Group data by date
            const dailyData = {};
            filteredTables.forEach(table => {
                const date = new Date(table.visitDate || table.date).toDateString();
                if (!dailyData[date]) {
                    dailyData[date] = 0;
                }
                dailyData[date] += parseFloat(table.totalBill || 0);
            });

            // Sort dates
            const sortedDates = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
            const labels = sortedDates.map(date => new Date(date).toLocaleDateString('th-TH', { month: 'short', day: 'numeric' }));
            const data = sortedDates.map(date => dailyData[date]);

            analyticsCharts.dailyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ยอดขายรายวัน (฿)',
                        data: data,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '฿' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update analytics detail table
        function updateAnalyticsDetailTable() {
            const tbody = document.getElementById('analyticsDetailTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            // Calculate group statistics
            const groupStats = {};
            const totalRevenue = filteredTables.reduce((sum, t) => sum + t.totalBill, 0);
            
            filteredTables.forEach(table => {
                const group = table.customerGroup;
                if (!groupStats[group]) {
                    groupStats[group] = {
                        tableCount: 0,
                        customerCount: 0,
                        totalRevenue: 0
                    };
                }
                
                groupStats[group].tableCount++;
                groupStats[group].customerCount += table.customers.length;
                groupStats[group].totalRevenue += table.totalBill;
            });

            Object.keys(groupStats).forEach(group => {
                const stats = groupStats[group];
                const avgBill = stats.totalRevenue / stats.tableCount;
                const avgPerHead = stats.totalRevenue / stats.customerCount;
                const revenuePercent = totalRevenue > 0 ? ((stats.totalRevenue / totalRevenue) * 100).toFixed(1) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${group}</strong></td>
                    <td>${stats.tableCount}</td>
                    <td>${stats.customerCount}</td>
                    <td>฿${stats.totalRevenue.toLocaleString()}</td>
                    <td>฿${Math.round(avgBill).toLocaleString()}</td>
                    <td>฿${Math.round(avgPerHead).toLocaleString()}</td>
                    <td>${revenuePercent}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Initialize analytics when tab is shown
        function initializeAnalytics() {
            // Start with local data
            filteredTables = [...tables];
            
            if (filteredTables.length === 0) {
                // No local data, try to sync from Google Sheets
                syncAnalyticsData();
            } else {
                // Show local data first, then sync in background
                applyFilters();
                
                // Auto-sync in background if Google Sheets is configured
                if (googleAPI.scriptUrl) {
                    setTimeout(() => {
                        syncAnalyticsData();
                    }, 1000);
                }
            }
        }

        // Update analytics (legacy function - now calls new analytics)
        function updateAnalytics() {
            updateAnalyticsDisplay();
        }

        // Update group analytics (legacy function)
        function updateGroupAnalytics() {
            updateAnalyticsDetailTable();
        }

        // Authentication functions
        function checkLogin() {
            const savedLogin = sessionStorage.getItem('isshoLoggedIn');
            if (savedLogin === 'true') {
                isLoggedIn = true;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'flex';
            }
        }

        function login(username, password) {
            if (username === VALID_USERNAME && password === VALID_PASSWORD) {
                isLoggedIn = true;
                sessionStorage.setItem('isshoLoggedIn', 'true');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'flex';
                return true;
            }
            return false;
        }

        function logout() {
            isLoggedIn = false;
            sessionStorage.removeItem('isshoLoggedIn');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.add('d-none');
        }

        function showClearDataModal() {
            const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').classList.add('d-none');
            modal.show();
        }

        function confirmClearData() {
            const password = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            
            if (password === VALID_PASSWORD) {
                // Clear data
                tables = [];
                saveLocalData();
                updateStats();
                updateTableList();
                updateAnalytics();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('passwordModal'));
                modal.hide();
                
                showSuccessAlert('ลบข้อมูลในเครื่องเรียบร้อยแล้ว');
            } else {
                errorDiv.classList.remove('d-none');
                document.getElementById('confirmPassword').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('confirmPassword').classList.remove('shake');
                }, 500);
            }
        }

        // Google Sheets Integration
        class GoogleSheetsAPI {
            constructor() {
                this.scriptUrl = localStorage.getItem('googleScriptUrl') || '';
            }

            setUrl(url) {
                this.scriptUrl = url;
                localStorage.setItem('googleScriptUrl', url);
                updateConnectionStatus();
            }

            async sendData(data) {
                if (!this.scriptUrl) {
                    throw new Error('ยังไม่ได้ตั้งค่า Google Apps Script URL');
                }

                try {
                    updateConnectionStatus('sending');
                    
                    const response = await fetch(this.scriptUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify(data),
                        redirect: 'follow'
                    });

                    updateConnectionStatus('online');
                    return { success: true, message: 'ส่งข้อมูลไป Google Sheets เรียบร้อย' };
                    
                } catch (error) {
                    updateConnectionStatus('error');
                    throw new Error('ไม่สามารถส่งข้อมูลไป Google Sheets ได้: ' + error.message);
                }
            }

            async loadData() {
                if (!this.scriptUrl) {
                    throw new Error('ยังไม่ได้ตั้งค่า Google Apps Script URL');
                }

                try {
                    updateConnectionStatus('loading');
                    
                    console.log('Fetching data from:', this.scriptUrl + '?action=getData');
                    
                    // Try to fetch data from Google Sheets using GET request
                    const response = await fetch(this.scriptUrl + '?action=getData', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        redirect: 'follow'
                    });
                    
                    console.log('Response status:', response.status);
                    
                    if (response.ok) {
                        const responseText = await response.text();
                        console.log('Raw response:', responseText);
                        
                        try {
                            const data = JSON.parse(responseText);
                            console.log('Parsed data:', data);
                            
                            updateConnectionStatus('online');
                            
                            return { 
                                success: true, 
                                data: data.tables || data.data || data || [], 
                                message: data.message || 'โหลดข้อมูลจาก Google Sheets สำเร็จ' 
                            };
                        } catch (parseError) {
                            console.error('JSON Parse error:', parseError);
                            return { 
                                success: false, 
                                data: [], 
                                message: 'ข้อมูลที่ได้รับไม่ใช่ JSON format' 
                            };
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.error('Load data error:', error);
                    updateConnectionStatus('error');
                    
                    return { 
                        success: false, 
                        data: [], 
                        message: `ไม่สามารถเชื่อมต่อ Google Sheets: ${error.message}` 
                    };
                }
            }

            async testConnection() {
                if (!this.scriptUrl) {
                    throw new Error('กรุณาใส่ Google Apps Script URL ก่อน');
                }

                try {
                    updateConnectionStatus('testing');
                    
                    const response = await fetch(this.scriptUrl + '?test=true', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        redirect: 'follow'
                    });

                    if (response.ok) {
                        updateConnectionStatus('online');
                        return { success: true, message: 'เชื่อมต่อ Google Sheets สำเร็จ' };
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    updateConnectionStatus('error');
                    throw new Error('ไม่สามารถเชื่อมต่อได้: ' + error.message);
                }
            }
        }

        // Initialize Google Sheets API
        const googleAPI = new GoogleSheetsAPI();

        // Connection status management
        function updateConnectionStatus(status = null) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (!statusElement || !statusText) return;

            statusElement.style.display = 'block';
            
            switch (status) {
                case 'online':
                    statusElement.className = 'connection-status status-online';
                    statusText.textContent = 'เชื่อมต่อแล้ว';
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 3000);
                    break;
                case 'offline':
                    statusElement.className = 'connection-status status-offline';
                    statusText.textContent = 'ออฟไลน์';
                    break;
                case 'error':
                    statusElement.className = 'connection-status status-error';
                    statusText.textContent = 'การเชื่อมต่อมีปัญหา';
                    break;
                case 'sending':
                    statusElement.className = 'connection-status status-offline';
                    statusText.textContent = 'กำลังส่งข้อมูล...';
                    break;
                case 'loading':
                    statusElement.className = 'connection-status status-offline';
                    statusText.textContent = 'กำลังโหลดข้อมูล...';
                    break;
                case 'testing':
                    statusElement.className = 'connection-status status-offline';
                    statusText.textContent = 'กำลังทดสอบ...';
                    break;
                default:
                    if (googleAPI.scriptUrl) {
                        statusElement.className = 'connection-status status-online';
                        statusText.textContent = 'พร้อมใช้งาน';
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                        }, 3000);
                    } else {
                        statusElement.className = 'connection-status status-offline';
                        statusText.textContent = 'ยังไม่ได้ตั้งค่า';
                    }
            }
        }

        // Initialize app
        function startApp() {
            if (!isLoggedIn) {
                logout();
                return;
            }

            console.log('Starting app...');
            
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Load settings
            const savedUrl = localStorage.getItem('googleScriptUrl');
            if (savedUrl) {
                document.getElementById('scriptUrl').value = savedUrl;
                googleAPI.setUrl(savedUrl);
            }
            
            // Load local data first
            loadLocalData();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('visitDate').value = today;
            
            // Initialize all components
            updateDateTime();
            updateStats();
            updateTableList();
            addCustomer();
            setupEventListeners();
            updateConnectionStatus();
            
            console.log('App started successfully');
        }

        // Load data from memory
        function loadLocalData() {
            const savedData = localStorage.getItem('isshoTablesLocal');
            if (savedData) {
                try {
                    tables = JSON.parse(savedData);
                    console.log('Loaded local data:', tables.length, 'tables');
                } catch (error) {
                    console.error('Error loading local data:', error);
                    tables = [];
                }
            }
        }

        // Save data to memory
        function saveLocalData() {
            try {
                localStorage.setItem('isshoTablesLocal', JSON.stringify(tables));
            } catch (error) {
                console.error('Error saving local data:', error);
                showErrorAlert('ไม่สามารถบันทึกข้อมูลในเครื่องได้');
            }
        }

        // Settings functions
        function saveSettings() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) {
                showErrorAlert('กรุณาใส่ Google Apps Script URL');
                return;
            }

            googleAPI.setUrl(url);
            showSuccessAlert('บันทึกการตั้งค่าเรียบร้อย');
        }

        function testConnection() {
            googleAPI.testConnection()
                .then(result => {
                    showSuccessAlert(result.message);
                })
                .catch(error => {
                    showErrorAlert(error.message);
                });
        }

        function syncData() {
            if (!googleAPI.scriptUrl) {
                showErrorAlert('กรุณาตั้งค่า Google Apps Script URL ก่อน');
                return;
            }
            loadDataFromSheets();
        }

        // Load data from Google Sheets
        function loadDataFromSheets() {
            if (!googleAPI.scriptUrl) {
                showErrorAlert('กรุณาตั้งค่า Google Apps Script URL ก่อน');
                return;
            }
            
            googleAPI.loadData()
                .then(result => {
                    if (result.success && result.data.length > 0) {
                        // Merge with local data
                        const sheetsData = result.data;
                        let newDataCount = 0;
                        
                        sheetsData.forEach(sheetTable => {
                            const exists = tables.find(localTable => 
                                localTable.id === sheetTable.id ||
                                (localTable.visitDate === sheetTable.visitDate && 
                                 localTable.tableNumber === sheetTable.tableNumber &&
                                 localTable.totalBill === sheetTable.totalBill)
                            );
                            
                            if (!exists) {
                                tables.push(sheetTable);
                                newDataCount++;
                            }
                        });
                        
                        // Save merged data locally
                        saveLocalData();
                        updateStats();
                        updateTableList();
                        
                        if (newDataCount > 0) {
                            showSuccessAlert(`โหลดข้อมูลใหม่ ${newDataCount} โต๊ะจาก Google Sheets (รวม ${tables.length} โต๊ะ)`);
                        } else {
                            showSuccessAlert(`ข้อมูลล่าสุดแล้ว - มีข้อมูลทั้งหมด ${tables.length} โต๊ะ`);
                        }
                    } else {
                        showSuccessAlert(`${result.message} - มีข้อมูลในเครื่อง ${tables.length} โต๊ะ`);
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    showErrorAlert(`ไม่สามารถโหลดข้อมูลได้: ${error.message}`);
                });
        }

        // Setup event listeners
        function setupEventListeners() {
            try {
                // Login form
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const username = document.getElementById('username').value;
                        const password = document.getElementById('password').value;
                        const errorDiv = document.getElementById('loginError');
                        
                        if (login(username, password)) {
                            errorDiv.classList.add('d-none');
                        } else {
                            errorDiv.classList.remove('d-none');
                            document.querySelector('.login-card').classList.add('shake');
                            setTimeout(() => {
                                document.querySelector('.login-card').classList.remove('shake');
                            }, 500);
                        }
                    });
                }
                
                // Form submission
                const form = document.getElementById('tableForm');
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                }
                
                // Search functionality
                const searchInput = document.getElementById('searchTable');
                if (searchInput) {
                    searchInput.addEventListener('input', handleSearch);
                }
                
                console.log('Event listeners setup completed');
            } catch (error) {
                console.error('Error setting up event listeners:', error);
            }
        }

        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!isLoggedIn) {
                logout();
                return;
            }
            
            try {
                showLoading();
                
                const customers = collectCustomerData();
                if (customers.length === 0) {
                    throw new Error('กรุณาใส่ข้อมูลลูกค้าอย่างน้อย 1 คน');
                }
                
                // Generate auto table number
                const currentDate = document.getElementById('visitDate').value;
                const dateStr = currentDate.replace(/-/g, '');
                const timeStr = new Date().getTime().toString().slice(-4);
                const autoTableNumber = `T${dateStr}-${timeStr}`;
                
                const tableData = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    visitDate: document.getElementById('visitDate').value,
                    tableNumber: autoTableNumber,
                    customerGroup: document.getElementById('customerGroup').value,
                    totalBill: parseFloat(document.getElementById('totalBill').value),
                    visitTime: document.getElementById('visitTime').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    occasion: document.getElementById('occasion').value,
                    satisfaction: document.getElementById('satisfaction').value,
                    notes: document.getElementById('notes').value,
                    customers: customers
                };

                // Validate data
                validateTableData(tableData);

                // Save locally first
                tables.push(tableData);
                saveLocalData();
                
                // Try to send to Google Sheets
                if (googleAPI.scriptUrl) {
                    googleAPI.sendData(tableData)
                        .then(result => {
                            showSuccessAlert(`บันทึกข้อมูลสำเร็จ! โต๊ะ ${autoTableNumber} (${customers.length} คน)\n${result.message}`);
                        })
                        .catch(error => {
                            console.error('Google Sheets error:', error);
                            showWarningAlert(`บันทึกในเครื่องสำเร็จ แต่ส่งไป Google Sheets ไม่ได้\nโต๊ะ ${autoTableNumber} - ${error.message}`);
                        });
                } else {
                    showSuccessAlert(`บันทึกข้อมูลในเครื่องสำเร็จ! โต๊ะ ${autoTableNumber} (${customers.length} คน)\nยังไม่ได้ตั้งค่า Google Sheets`);
                }
                
                resetForm();
                updateStats();
                updateTableList();
                updateAnalytics();
                
            } catch (error) {
                showErrorAlert(error.message);
            } finally {
                hideLoading();
            }
        }

        // Validate table data
        function validateTableData(data) {
            if (!data.customerGroup) {
                throw new Error('กรุณาเลือกกลุ่มลูกค้า');
            }
            if (!data.totalBill || data.totalBill <= 0) {
                throw new Error('กรุณาใส่ยอดขายที่มากกว่า 0');
            }
            if (!data.visitTime) {
                throw new Error('กรุณาเลือกเวลาเข้าใช้บริการ');
            }
            if (!data.visitDate) {
                throw new Error('กรุณาเลือกวันที่เข้าใช้บริการ');
            }
        }

        // Collect customer data from form
        function collectCustomerData() {
            const customerCards = document.querySelectorAll('.customer-card');
            const customers = [];
            
            customerCards.forEach(card => {
                const gender = card.querySelector('.customer-gender').value;
                const age = card.querySelector('.customer-age').value;
                const type = card.querySelector('.customer-type').value;
                
                if (gender && age) {
                    customers.push({
                        gender: gender,
                        age: age,
                        type: type || 'ลูกค้าใหม่'
                    });
                }
            });
            
            return customers;
        }

        // Show loading state
        function showLoading() {
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>กำลังบันทึก...';
            }
        }

        // Hide loading state
        function hideLoading() {
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>บันทึกข้อมูล';
            }
        }

        // Alert functions
        function showSuccessAlert(message) {
            showAlert(message, 'success');
        }

        function showErrorAlert(message) {
            showAlert(message, 'danger');
        }

        function showWarningAlert(message) {
            showAlert(message, 'warning');
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-custom alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message.replace(/\n/g, '<br>')}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto remove after timeout
            const timeout = type === 'success' ? 7000 : 10000;
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, timeout);
        }

        // Update date and time
        function updateDateTime() {
            try {
                const now = new Date();
                const options = { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                };
                
                const dateEl = document.getElementById('currentDate');
                const timeEl = document.getElementById('currentTime');
                
                if (dateEl) {
                    dateEl.textContent = now.toLocaleDateString('th-TH', options);
                }
                if (timeEl) {
                    timeEl.textContent = now.toLocaleTimeString('th-TH');
                }
            } catch (error) {
                console.error('Error updating date/time:', error);
            }
        }

        // Add customer to table
        function addCustomer() {
            customerCounter++;
            const container = document.getElementById('customersContainer');
            if (!container) return;
            
            const customerCard = document.createElement('div');
            customerCard.className = 'customer-card';
            customerCard.id = `customer-${customerCounter}`;
            
            customerCard.innerHTML = `
                <div class="customer-card-header">
                    <div class="customer-number">
                        <i class="fas fa-user me-2"></i>ลูกค้าคนที่ ${customerCounter}
                    </div>
                    <button type="button" class="remove-customer" onclick="removeCustomer(${customerCounter})" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="customer-form-row">
                    <div>
                        <label class="form-label">เพศ *</label>
                        <select class="form-control customer-gender" required onchange="updateCustomerCard(${customerCounter})">
                            <option value="">เลือกเพศ</option>
                            <option value="ชาย">ชาย</option>
                            <option value="หญิง">หญิง</option>
                            <option value="LGBTQ+(เพศสภาพชาย)">LGBTQ+(เพศสภาพชาย)</option>
                            <option value="LGBTQ+(เพศสภาพหญิง)">LGBTQ+(เพศสภาพหญิง)</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">อายุ *</label>
                        <select class="form-control customer-age" required onchange="updateCustomerCard(${customerCounter})">
                            <option value="">เลือกช่วงอายุ</option>
                            <option value="0-12">0-12 ปี (เด็ก)</option>
                            <option value="13-17">13-17 ปี (วัยรุ่นตอนต้น)</option>
                            <option value="18-25">18-25 ปี (วัยรุ่นตอนปลาย)</option>
                            <option value="26-35">26-35 ปี (วัยผู้ใหญ่ตอนต้น)</option>
                            <option value="36-45">36-45 ปี (วัยผู้ใหญ่ตอนกลาง)</option>
                            <option value="46-55">46-55 ปี (วัยกลางคน)</option>
                            <option value="56-65">56-65 ปี (วัยผู้สูงอายุตอนต้น)</option>
                            <option value="66+">66+ ปี (วัยผู้สูงอายุ)</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">ประเภทลูกค้า</label>
                        <select class="form-control customer-type" onchange="updateCustomerCard(${customerCounter})">
                            <option value="ลูกค้าใหม่">ลูกค้าใหม่</option>
                            <option value="ลูกค้าประจำ">ลูกค้าประจำ</option>
                            <option value="ลูกค้าVIP">ลูกค้า VIP</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(customerCard);
            updateRemoveButtons();
        }

        // Remove customer
        function removeCustomer(id) {
            const customerCard = document.getElementById(`customer-${id}`);
            if (customerCard) {
                customerCard.remove();
                updateRemoveButtons();
                renumberCustomers();
            }
        }

        // Renumber customers after removal
        function renumberCustomers() {
            const customerCards = document.querySelectorAll('.customer-card');
            customerCards.forEach((card, index) => {
                const header = card.querySelector('.customer-number');
                if (header) {
                    header.innerHTML = `<i class="fas fa-user me-2"></i>ลูกค้าคนที่ ${index + 1}`;
                }
            });
        }

        // Update customer card styling
        function updateCustomerCard(id) {
            const card = document.getElementById(`customer-${id}`);
            if (!card) return;
            
            const gender = card.querySelector('.customer-gender').value;
            const age = card.querySelector('.customer-age').value;
            
            if (gender && age) {
                card.classList.add('filled');
            } else {
                card.classList.remove('filled');
            }
        }

        // Update remove buttons visibility
        function updateRemoveButtons() {
            const customers = document.querySelectorAll('.customer-card');
            customers.forEach(card => {
                const removeBtn = card.querySelector('.remove-customer');
                if (removeBtn) {
                    removeBtn.style.display = customers.length > 1 ? 'flex' : 'none';
                }
            });
        }

        // Reset form
        function resetForm() {
            const form = document.getElementById('tableForm');
            if (form) {
                form.reset();
            }
            
            const container = document.getElementById('customersContainer');
            if (container) {
                container.innerHTML = '';
            }
            
            customerCounter = 0;
            addCustomer();

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('visitDate').value = today;
        }

        // Update stats
        function updateStats() {
            try {
                const totalCustomers = tables.reduce((sum, table) => sum + table.customers.length, 0);
                const totalRevenue = tables.reduce((sum, table) => sum + parseFloat(table.totalBill || 0), 0);
                const avgPerHead = totalCustomers > 0 ? totalRevenue / totalCustomers : 0;

                const elements = {
                    totalTables: document.getElementById('totalTables'),
                    totalCustomers: document.getElementById('totalCustomers'),
                    totalRevenue: document.getElementById('totalRevenue'),
                    avgPerHead: document.getElementById('avgPerHead')
                };

                if (elements.totalTables) elements.totalTables.textContent = tables.length.toLocaleString();
                if (elements.totalCustomers) elements.totalCustomers.textContent = totalCustomers.toLocaleString();
                if (elements.totalRevenue) elements.totalRevenue.textContent = totalRevenue.toLocaleString();
                if (elements.avgPerHead) elements.avgPerHead.textContent = Math.round(avgPerHead).toLocaleString();
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Update table list
        function updateTableList() {
            try {
                const tbody = document.getElementById('tableListBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                tables.sort((a, b) => new Date(b.visitDate || b.date) - new Date(a.visitDate || a.date)).forEach(table => {
                    const row = document.createElement('tr');
                    const date = new Date(table.visitDate || table.date).toLocaleDateString('th-TH');
                    const avgPerHead = table.totalBill / table.customers.length;
                    const satisfaction = table.satisfaction ? '★'.repeat(parseInt(table.satisfaction)) + '☆'.repeat(5-parseInt(table.satisfaction)) : '-';
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${table.tableNumber}</td>
                        <td><span class="badge bg-info">${table.customerGroup}</span></td>
                        <td>${table.customers.length} คน</td>
                        <td>฿${table.totalBill.toLocaleString()}</td>
                        <td>฿${Math.round(avgPerHead).toLocaleString()}</td>
                        <td><small>${table.visitTime}</small></td>
                        <td>${satisfaction}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="viewTableDetails(${table.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTable(${table.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error updating table list:', error);
            }
        }

        // View table details
        function viewTableDetails(id) {
            const table = tables.find(t => t.id === id);
            if (!table) return;

            let customerDetails = table.customers.map((customer, index) => 
                `คนที่ ${index + 1}: ${customer.gender}, อายุ ${customer.age}, ${customer.type}`
            ).join('\n');

            const avgPerHead = Math.round(table.totalBill / table.customers.length);
            
            alert(`รายละเอียดโต๊ะ ${table.tableNumber}\n\n` +
                  `กลุ่มลูกค้า: ${table.customerGroup}\n` +
                  `จำนวนคน: ${table.customers.length} คน\n` +
                  `ยอดขาย: ฿${table.totalBill.toLocaleString()}\n` +
                  `เฉลี่ยต่อหัว: ฿${avgPerHead.toLocaleString()}\n` +
                  `เวลา: ${table.visitTime}\n` +
                  `หมายเหตุ: ${table.notes || 'ไม่มี'}\n\n` +
                  `รายละเอียดลูกค้า:\n${customerDetails}`);
        }

        // Delete table
        function deleteTable(id) {
            if (confirm('คุณต้องการลบข้อมูลโต๊ะนี้หรือไม่?\n(จะลบเฉพาะในเครื่อง ข้อมูลใน Google Sheets จะไม่ถูกลบ)')) {
                tables = tables.filter(t => t.id !== id);
                saveLocalData();
                updateStats();
                updateTableList();
                updateAnalytics();
                showSuccessAlert('ลบข้อมูลเรียบร้อยแล้ว');
            }
        }

        // Handle search
        function handleSearch(e) {
            try {
                const searchTerm = e.target.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#tableListBody tr');
                
                rows.forEach(row => {
                    if (!searchTerm) {
                        row.style.display = '';
                        return;
                    }
                    
                    const searchableText = [
                        row.cells[0]?.textContent, // วันที่
                        row.cells[1]?.textContent, // โต๊ะ
                        row.cells[2]?.textContent, // กลุ่มลูกค้า
                        row.cells[4]?.textContent  // ยอดขาย
                    ].join(' ').toLowerCase();
                    
                    row.style.display = searchableText.includes(searchTerm) ? '' : 'none';
                });
            } catch (error) {
                console.error('Error in search:', error);
            }
        }

        // Export to CSV
        function exportToCSV() {
            try {
                if (tables.length === 0) {
                    showErrorAlert('ไม่มีข้อมูลให้ส่งออก');
                    return;
                }

                const headers = [
                    'วันที่เข้าใช้บริการ', 'วันที่บันทึก', 'โต๊ะ', 'กลุ่มลูกค้า', 'จำนวนคน', 'ยอดขายรวม', 'เฉลี่ยต่อหัว',
                    'เวลาเข้าใช้บริการ', 'วิธีชำระเงิน', 'โอกาสพิเศษ', 'ความพึงพอใจ',
                    'เพศลูกค้า', 'อายุลูกค้า', 'ประเภทลูกค้า', 'หมายเหตุ'
                ];

                let csvContent = '\ufeff' + headers.join(',') + '\n';

                tables.forEach(table => {
                    const baseData = [
                        formatDateForCSV(table.visitDate || table.date),
                        formatDateForCSV(table.date),
                        escapeCSV(table.tableNumber),
                        escapeCSV(table.customerGroup),
                        table.customers.length,
                        table.totalBill,
                        Math.round(table.totalBill / table.customers.length),
                        escapeCSV(table.visitTime),
                        escapeCSV(table.paymentMethod),
                        escapeCSV(table.occasion),
                        table.satisfaction || ''
                    ];

                    table.customers.forEach((customer, index) => {
                        const row = [
                            ...baseData,
                            escapeCSV(customer.gender),
                            escapeCSV(customer.age),
                            escapeCSV(customer.type),
                            index === 0 ? escapeCSV(table.notes) : ''
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                });

                downloadCSV(csvContent, `issho_tables_${getCurrentDateString()}.csv`);
                showSuccessAlert('ส่งออกข้อมูล CSV เรียบร้อยแล้ว');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showErrorAlert('เกิดข้อผิดพลาดในการส่งออกข้อมูล');
            }
        }

        // Helper functions
        function escapeCSV(field) {
            if (field === null || field === undefined) return '""';
            const str = String(field);
            if (str.includes('"') || str.includes(',') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return `"${str}"`;
        }

        function formatDateForCSV(date) {
            return new Date(date).toLocaleDateString('th-TH');
        }

        function getCurrentDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize time updates
        setInterval(updateDateTime, 1000);

        // Tab change event listener
        document.addEventListener('shown.bs.tab', function (event) {
            if (event.target.getAttribute('data-bs-target') === '#analytics') {
                setTimeout(() => {
                    initializeAnalytics();
                }, 100);
            }
        });

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            setupEventListeners();
            checkLogin();
        });
    </script>
</body>
</html>
