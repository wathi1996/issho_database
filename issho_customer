<!-- Group Analytics -->
                    <div class="card card-custom mb-4">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0"><i class="fas fa-chart-pie me-2 text-danger"></i>วิเคราะห์ตามกลุ่มลูกค้า</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>กลุ่มลูกค้า</th>
                                            <th>จำนวนโต๊ะ</th>
                                            <th>จำนวนคน</th>
                                            <th>ยอดขายรวม</th>
                                            <th>เฉลี่ยต่อบิล</th>
                                            <th>เฉลี่ยต่อหัว</th>
                                            <th>% ของยอดขาย</th>
                                        </tr>
                                    </thead>
                                    <tbody id="groupAnalyticsTable">
                                        <!-- Group analytics will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <div class="card card-custom">
                        <div class="card-header bg-transparent">
                            <h5 class="mb-0"><i class="fas fa-cog me-2 text-danger"></i>ตั้งค่าระบบ</h5>
                        </div>
                        <div class="card-body">
                            <div class="settings-card">
                                <h6><i class="fas fa-link me-2"></i>การเชื่อมต่อ Google Sheets</h6>
                                <div class="row mt-3">
                                    <div class="col-md-8 mb-3">
                                        <label class="form-label text-white">Google Apps Script URL</label>
                                        <input type="url" class="form-control" id="scriptUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                                    </div>
                                    <div class="col-md-4 mb-3 d-flex align-items-end">
                                        <button class="btn btn-light w-100" onclick="saveSettings()">
                                            <i class="fas fa-save me-2"></i>บันทึกการตั้งค่า
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-light">
                                        <i class="fas fa-info-circle me-1"></i>
                                        URL ที่ได้จากการ Deploy Google Apps Script
                                    </small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-test-tube me-2"></i>ทดสอบการเชื่อมต่อ</h6>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-outline-primary w-100 mb-2" onclick="testConnection()">
                                                <i class="fas fa-plug me-2"></i>ทดสอบการเชื่อมต่อ
                                            </button>
                                            <button class="btn btn-outline-success w-100" onclick="loadDataFromSheets()">
                                                <i class="fas fa-download me-2"></i>โหลดข้อมูลจาก Sheets
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-database me-2"></i>จัดการข้อมูล</h6>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-outline-warning w-100 mb-2" onclick="clearLocalData()">
                                                <i class="fas fa-broom me-2"></i>ล้างข้อมูลในเครื่อง
                                            </button>
                                            <button class="btn btn-outline-info w-100" onclick="syncData()">
                                                <i class="fas fa-sync me-2"></i>ซิงค์ข้อมูล
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-4">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>วิธีการตั้งค่า Google Sheets</h6>
                                </div>
                                <div class="card-body">
                                    <ol class="mb-0">
                                        <li class="mb-2">สร้าง Google Sheets ใหม่และตั้งชื่อคอลัมน์ตามที่กำหนด</li>
                                        <li class="mb-2">เปิด Extensions > Apps Script</li>
                                        <li class="mb-2">วาง Code ที่ให้ไว้และ Deploy เป็น Web App</li>
                                        <li class="mb-2">คัดลอก URL ที่ได้มาใส่ในช่องด้านบน</li>
                                        <li>ทดสอบการเชื่อมต่อ</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let tables = [];
        let customerCounter = 0;
        let googleScriptUrl = '';
        let isOnline = navigator.onLine;

        // Google Sheets Integration
        class GoogleSheetsAPI {
            constructor() {
                this.scriptUrl = localStorage.getItem('googleScriptUrl') || '';
            }

            setUrl(url) {
                this.scriptUrl = url;
                localStorage.setItem('googleScriptUrl', url);
                updateConnectionStatus();
            }

            async sendData(data) {
                if (!this.scriptUrl) {
                    throw new Error('ยังไม่ได้ตั้งค่า Google Apps Script URL');
                }

                try {
                    updateConnectionStatus('sending');
                    
                    const response = await fetch(this.scriptUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                        mode: 'no-cors'
                    });

                    // เนื่องจาก no-cors เราไม่สามารถอ่าน response ได้
                    // แต่ถ้าไม่มี error แสดงว่าส่งสำเร็จ
                    updateConnectionStatus('online');
                    return { success: true, message: 'ส่งข้อมูลไป Google Sheets เรียบร้อย' };
                    
                } catch (error) {
                    updateConnectionStatus('error');
                    console.error('Error sending to Google Sheets:', error);
                    throw new Error('ไม่สามารถส่งข้อมูลไป Google Sheets ได้: ' + error.message);
                }
            }

            async loadData() {
                if (!this.scriptUrl) {
                    throw new Error('ยังไม่ได้ตั้งค่า Google Apps Script URL');
                }

                try {
                    updateConnectionStatus('loading');
                    
                    const response = await fetch(this.scriptUrl + '?action=load', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const result = await response.json();
                    updateConnectionStatus('online');
                    
                    return result;
                    
                } catch (error) {
                    updateConnectionStatus('error');
                    console.error('Error loading from Google Sheets:', error);
                    throw new Error('ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้: ' + error.message);
                }
            }

            async testConnection() {
                if (!this.scriptUrl) {
                    throw new Error('กรุณาใส่ Google Apps Script URL ก่อน');
                }

                try {
                    updateConnectionStatus('testing');
                    
                    const response = await fetch(this.scriptUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    updateConnectionStatus('online');
                    return { success: true, message: 'เชื่อมต่อ Google Sheets สำเร็จ' };
                    
                } catch (error) {
                    updateConnectionStatus('error');
                    throw new Error('ไม่สามารถเชื่อมต่อได้: ' + error.message);
                }
            }
        }

        // Initialize Google Sheets API
        const googleAPI = new GoogleSheetsAPI();

        // Connection status management
        function updateConnectionStatus(status = null) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (!statusElement || !statusText) return;

            statusElement.style.display = 'block';
            
            switch (status) {
                case 'online':
                    statusElement.className = 'connection-status status-online';
                    statusText.textContent = 'เชื่อมต่อแล้ว';
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 3000);
                    break;
                case 'offline':
                    statusElement.className = 'connection-status status-offline';
                    statusText.textContent = 'ออฟไลน์';
                    break;
                case 'error':
                    statusElement.className = 'connection-status status-error';
                    statusText.textContent = 'การเชื่อมต่อมีปัญหา';
                    break;
                case 'sending':
                    statusElement.className = 'connection-status status-offline';
                    statusText.textContent = 'กำลังส่งข้อมูล...';
                    break;
                case 'loading':
                    statusElement.className = 'connection-status status-offline';
                    statusText.textContent = 'กำลังโหลดข้อมูล...';
                    break;
                case 'testing':
                    statusElement.className = 'connection-status status-offline';
                    statusText.textContent = 'กำลังทดสอบ...';
                    break;
                default:
                    if (googleAPI.scriptUrl) {
                        statusElement.className = 'connection-status status-online';
                        statusText.textContent = 'พร้อมใช้งาน';
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                        }, 3000);
                    } else {
                        statusElement.className = 'connection-status status-offline';
                        statusText.textContent = 'ยังไม่ได้ตั้งค่า';
                    }
            }
        }

        // Initialize app
        function startApp() {
            console.log('Starting app...');
            
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Load settings
            const savedUrl = localStorage.getItem('googleScriptUrl');
            if (savedUrl) {
                document.getElementById('scriptUrl').value = savedUrl;
                googleAPI.setUrl(savedUrl);
            }
            
            // Load local data first
            loadLocalData();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('visitDate').value = today;
            
            // Initialize all components
            updateDateTime();
            updateStats();
            updateTableList();
            addCustomer();
            setupEventListeners();
            updateConnectionStatus();
            
            // Try to sync with Google Sheets if URL is set
            if (googleAPI.scriptUrl) {
                setTimeout(() => {
                    syncData();
                }, 2000);
            }
            
            console.log('App started successfully');
        }

        // Load data from localStorage
        function loadLocalData() {
            const savedData = localStorage.getItem('isshoTablesLocal');
            if (savedData) {
                try {
                    tables = JSON.parse(savedData);
                    console.log('Loaded local data:', tables.length, 'tables');
                } catch (error) {
                    console.error('Error loading local data:', error);
                    tables = [];
                }
            }
        }

        // Save data to localStorage
        function saveLocalData() {
            try {
                localStorage.setItem('isshoTablesLocal', JSON.stringify(tables));
            } catch (error) {
                console.error('Error saving local data:', error);
                showErrorAlert('ไม่สามารถบันทึกข้อมูลในเครื่องได้');
            }
        }

        // Settings functions
        function saveSettings() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) {
                showErrorAlert('กรุณาใส่ Google Apps Script URL');
                return;
            }

            googleAPI.setUrl(url);
            showSuccessAlert('บันทึกการตั้งค่าเรียบร้อย');
        }

        function testConnection() {
            googleAPI.testConnection()
                .then(result => {
                    showSuccessAlert(result.message);
                })
                .catch(error => {
                    showErrorAlert(error.message);
                });
        }

        function syncData() {
            if (!googleAPI.scriptUrl) {
                showErrorAlert('กรุณาตั้งค่า Google Apps Script URL ก่อน');
                return;
            }

            loadDataFromSheets();
        }

        function clearLocalData() {
            if (confirm('คุณต้องการลบข้อมูลในเครื่องทั้งหมดหรือไม่?\n(ข้อมูลใน Google Sheets จะไม่ถูกลบ)')) {
                tables = [];
                saveLocalData();
                updateStats();
                updateTableList();
                updateAnalytics();
                showSuccessAlert('ลบข้อมูลในเครื่องเรียบร้อย');
            }
        }

        // Load data from Google Sheets
        function loadDataFromSheets() {
            googleAPI.loadData()
                .then(result => {
                    if (result.success && result.data) {
                        // Process Google Sheets data to match our format
                        const processedData = processGoogleSheetsData(result.data);
                        tables = processedData;
                        saveLocalData();
                        updateStats();
                        updateTableList();
                        updateAnalytics();
                        showSuccessAlert('โหลดข้อมูลจาก Google Sheets เรียบร้อย');
                    } else {
                        showErrorAlert('ไม่พบข้อมูลใน Google Sheets');
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    showErrorAlert(error.message);
                });
        }

        // Process data from Google Sheets format to our format
        function processGoogleSheetsData(sheetsData) {
            const processedTables = [];
            const tableGroups = {};

            // Group rows by table and date
            sheetsData.forEach(row => {
                const key = `${row['วันที่เข้าใช้บริการ']}_${row['โต๊ะ']}_${row['กลุ่มลูกค้า']}`;
                
                if (!tableGroups[key]) {
                    tableGroups[key] = {
                        id: Date.now() + Math.random(),
                        visitDate: row['วันที่เข้าใช้บริการ'],
                        date: row['วันที่บันทึก'],
                        tableNumber: row['โต๊ะ'],
                        customerGroup: row['กลุ่มลูกค้า'],
                        totalBill: parseFloat(row['ยอดขายรวม']) || 0,
                        visitTime: row['เวลาเข้าใช้บริการ'],
                        paymentMethod: row['วิธีชำระเงิน'],
                        occasion: row['โอกาสพิเศษ'],
                        satisfaction: row['ความพึงพอใจ'],
                        notes: row['หมายเหตุ'] || '',
                        customers: []
                    };
                }

                // Add customer to the table
                if (row['เพศลูกค้า'] && row['อายุลูกค้า']) {
                    tableGroups[key].customers.push({
                        gender: row['เพศลูกค้า'],
                        age: row['อายุลูกค้า'],
                        type: row['ประเภทลูกค้า'] || 'ลูกค้าใหม่'
                    });
                }
            });

            // Convert to array
            Object.values(tableGroups).forEach(table => {
                if (table.customers.length > 0) {
                    processedTables.push(table);
                }
            });

            return processedTables;
        }

        // Setup event listeners
        function setupEventListeners() {
            try {
                // Form submission
                const form = document.getElementById('tableForm');
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                }
                
                // Search functionality
                const searchInput = document.getElementById('searchTable');
                if (searchInput) {
                    searchInput.addEventListener('input', handleSearch);
                }
                
                // Online/offline detection
                window.addEventListener('online', () => {
                    isOnline = true;
                    updateConnectionStatus('online');
                });
                
                window.addEventListener('offline', () => {
                    isOnline = false;
                    updateConnectionStatus('offline');
                });
                
                console.log('Event listeners setup completed');
            } catch (error) {
                console.error('Error setting up event listeners:', error);
            }
        }

        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading();
                
                const customers = collectCustomerData();
                if (customers.length === 0) {
                    throw new Error('กรุณาใส่ข้อมูลลูกค้าอย่างน้อย 1 คน');
                }
                
                const tableData = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    visitDate: document.getElementById('visitDate').value,
                    tableNumber: document.getElementById('tableNumber').value || 'ไม่ระบุ',
                    customerGroup: document.getElementById('customerGroup').value,
                    totalBill: parseFloat(document.getElementById('totalBill').value),
                    visitTime: document.getElementById('visitTime').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    occasion: document.getElementById('occasion').value,
                    satisfaction: document.getElementById('satisfaction').value,
                    notes: document.getElementById('notes').value,
                    customers: customers
                };

                // Validate data
                validateTableData(tableData);

                // Save locally first
                tables.push(tableData);
                saveLocalData();
                
                // Try to send to Google Sheets
                if (googleAPI.scriptUrl && isOnline) {
                    googleAPI.sendData(tableData)
                        .then(result => {
                            showSuccessAlert(`บันทึกข้อมูลสำเร็จ! (${customers.length} คน)\n${result.message}`);
                        })
                        .catch(error => {
                            console.error('Google Sheets error:', error);
                            showWarningAlert(`บันทึกในเครื่องสำเร็จ แต่ส่งไป Google Sheets ไม่ได้\n${error.message}`);
                        });
                } else {
                    showSuccessAlert(`บันทึกข้อมูลในเครื่องสำเร็จ! (${customers.length} คน)\n${!googleAPI.scriptUrl ? 'ยังไม่ได้ตั้งค่า Google Sheets' : 'อยู่ในโหมดออฟไลน์'}`);
                }
                
                resetForm();
                updateStats();
                updateTableList();
                updateAnalytics();
                
            } catch (error) {
                showErrorAlert(error.message);
            } finally {
                hideLoading();
            }
        }

        // Validate table data
        function validateTableData(data) {
            if (!data.customerGroup) {
                throw new Error('กรุณาเลือกกลุ่มลูกค้า');
            }
            if (!data.totalBill || data.totalBill <= 0) {
                throw new Error('กรุณาใส่ยอดขายที่มากกว่า 0');
            }
            if (!data.visitTime) {
                throw new Error('กรุณาเลือกเวลาเข้าใช้บริการ');
            }
            if (!data.visitDate) {
                throw new Error('กรุณาเลือกวันที่เข้าใช้บริการ');
            }
        }

        // Collect customer data from form
        function collectCustomerData() {
            const customerCards = document.querySelectorAll('.customer-card');
            const customers = [];
            
            customerCards.forEach(card => {
                const gender = card.querySelector('.customer-gender').value;
                const age = card.querySelector('.customer-age').value;
                const type = card.querySelector('.customer-type').value;
                
                if (gender && age) {
                    customers.push({
                        gender: gender,
                        age: age,
                        type: type || 'ลูกค้าใหม่'
                    });
                }
            });
            
            return customers;
        }

        // Show loading state
        function showLoading() {
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>กำลังบันทึก...';
            }
        }

        // Hide loading state
        function hideLoading() {
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>บันทึกข้อมูล';
            }
        }

        // Alert functions
        function showSuccessAlert(message) {
            showAlert(message, 'success');
        }

        function showErrorAlert(message) {
            showAlert(message, 'danger');
        }

        function showWarningAlert(message) {
            showAlert(message, 'warning');
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-custom alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message.replace(/\n/g, '<br>')}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto remove after 7 seconds for success, 10 seconds for errors
            const timeout = type === 'success' ? 7000 : 10000;
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, timeout);
        }

        // Update date and time
        function updateDateTime() {
            try {
                const now = new Date();
                const options = { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                };
                
                const dateEl = document.getElementById('currentDate');
                const timeEl = document.getElementById('currentTime');
                
                if (dateEl) {
                    dateEl.textContent = now.toLocaleDateString('th-TH', options);
                }
                if (timeEl) {
                    timeEl.textContent = now.toLocaleTimeString('th-TH');
                }
            } catch (error) {
                console.error('Error updating date/time:', error);
            }
        }

        // Add customer to table
        function addCustomer() {
            customerCounter++;
            const container = document.getElementById('customersContainer');
            if (!container) return;
            
            const customerCard = document.createElement('div');
            customerCard.className = 'customer-card';
            customerCard.id = `customer-${customerCounter}`;
            
            customerCard.innerHTML = `
                <button type="button" class="remove-customer" onclick="removeCustomer(${customerCounter})" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">เพศ *</label>
                        <select class="form-control customer-gender" required onchange="updateCustomerCard(${customerCounter})">
                            <option value="">เลือกเพศ</option>
                            <option value="ชาย">ชาย</option>
                            <option value="หญิง">หญิง</option>
                            <option value="LGBTQ+(เพศสภาพชาย)">LGBTQ+(เพศสภาพชาย)</option>
                            <option value="LGBTQ+(เพศสภาพหญิง)">LGBTQ+(เพศสภาพหญิง)</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">อายุ *</label>
                        <select class="form-control customer-age" required onchange="updateCustomerCard(${customerCounter})">
                            <option value="">เลือกช่วงอายุ</option>
                            <option value="0-12">0-12 ปี (เด็ก)</option>
                            <option value="13-17">13-17 ปี (วัยรุ่นตอนต้น)</option>
                            <option value="18-25">18-25 ปี (วัยรุ่นตอนปลาย)</option>
                            <option value="26-35">26-35 ปี (วัยผู้ใหญ่ตอนต้น)</option>
                            <option value="36-45">36-45 ปี (วัยผู้ใหญ่ตอนกลาง)</option>
                            <option value="46-55">46-55 ปี (วัยกลางคน)</option>
                            <option value="56-65">56-65 ปี (วัยผู้สูงอายุตอนต้น)</option>
                            <option value="66+">66+ ปี (วัยผู้สูงอายุ)</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">ประเภทลูกค้า</label>
                        <select class="form-control customer-type" onchange="updateCustomerCard(${customerCounter})">
                            <option value="ลูกค้าใหม่">ลูกค้าใหม่</option>
                            <option value="ลูกค้าประจำ">ลูกค้าประจำ</option>
                            <option value="ลูกค้าVIP">ลูกค้า VIP</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(customerCard);
            updateRemoveButtons();
        }

        // Remove customer
        function removeCustomer(id) {
            const customerCard = document.getElementById(`customer-${id}`);
            if (customerCard) {
                customerCard.remove();
                updateRemoveButtons();
            }
        }

        // Update customer card styling
        function updateCustomerCard(id) {
            const card = document.getElementById(`customer-${id}`);
            if (!card) return;
            
            const gender = card.querySelector('.customer-gender').value;
            const age = card.querySelector('.customer-age').value;
            
            if (gender && age) {
                card.classList.add('filled');
            } else {
                card.classList.remove('filled');
            }
        }

        // Update remove buttons visibility
        function updateRemoveButtons() {
            const customers = document.querySelectorAll('.customer-card');
            customers.forEach(card => {
                const removeBtn = card.querySelector('.remove-customer');
                if (removeBtn) {
                    removeBtn.style.display = customers.length > 1 ? 'flex' : 'none';
                }
            });
        }

        // Reset form
        function resetForm() {
            const form = document.getElementById('tableForm');
            if (form) {
                form.reset();
            }
            
            const container = document.getElementById('customersContainer');
            if (container) {
                container.innerHTML = '';
            }
            
            customerCounter = 0;
            addCustomer();
        }

        // Update stats
        function updateStats() {
            try {
                const totalCustomers = tables.reduce((sum, table) => sum + table.customers.length, 0);
                const totalRevenue = tables.reduce((sum, table) => sum + parseFloat(table.totalBill || 0), 0);
                const avgPerHead = totalCustomers > 0 ? totalRevenue / totalCustomers : 0;

                const elements = {
                    totalTables: document.getElementById('totalTables'),
                    totalCustomers: document.getElementById('totalCustomers'),
                    totalRevenue: document.getElementById('totalRevenue'),
                    avgPerHead: document.getElementById('avgPerHead')
                };

                if (elements.totalTables) elements.totalTables.textContent = tables.length.toLocaleString();
                if (elements.totalCustomers) elements.totalCustomers.textContent = totalCustomers.toLocaleString();
                if (elements.totalRevenue) elements.totalRevenue.textContent = totalRevenue.toLocaleString();
                if (elements.avgPerHead) elements.avgPerHead.textContent = Math.round(avgPerHead).toLocaleString();
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Update table list
        function updateTableList() {
            try {
                const tbody = document.getElementById('tableListBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                tables.sort((a, b) => new Date(b.visitDate || b.date) - new Date(a.visitDate || a.date)).forEach(table => {
                    const row = document.createElement('tr');
                    const date = new Date(table.visitDate || table.date).toLocaleDateString('th-TH');
                    const avgPerHead = table.totalBill / table.customers.length;
                    const satisfaction = table.satisfaction ? '★'.repeat(parseInt(table.satisfaction)) + '☆'.repeat(5-parseInt(table.satisfaction)) : '-';
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${table.tableNumber}</td>
                        <td><span class="badge bg-info">${table.customerGroup}</span></td>
                        <td>${table.customers.length} คน</td>
                        <td>฿${table.totalBill.toLocaleString()}</td>
                        <td>฿${Math.round(avgPerHead).toLocaleString()}</td>
                        <td><small>${table.visitTime}</small></td>
                        <td>${satisfaction}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="viewTableDetails(${table.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTable(${table.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error updating table list:', error);
            }
        }

        // View table details
        function viewTableDetails(id) {
            const table = tables.find(t => t.id === id);
            if (!table) return;

            let customerDetails = table.customers.map((customer, index) => 
                `คนที่ ${index + 1}: ${customer.gender}, อายุ ${customer.age}, ${customer.type}`
            ).join('\n');

            const avgPerHead = Math.round(table.totalBill / table.customers.length);
            
            alert(`รายละเอียดโต๊ะ ${table.tableNumber}\n\n` +
                  `กลุ่มลูกค้า: ${table.customerGroup}\n` +
                  `จำนวนคน: ${table.customers.length} คน\n` +
                  `ยอดขาย: ฿${table.totalBill.toLocaleString()}\n` +
                  `เฉลี่ยต่อหัว: ฿${avgPerHead.toLocaleString()}\n` +
                  `เวลา: ${table.visitTime}\n` +
                  `หมายเหตุ: ${table.notes || 'ไม่มี'}\n\n` +
                  `รายละเอียดลูกค้า:\n${customerDetails}`);
        }

        // Delete table
        function deleteTable(id) {
            if (confirm('คุณต้องการลบข้อมูลโต๊ะนี้หรือไม่?\n(จะลบเฉพาะในเครื่อง ข้อมูลใน Google Sheets จะไม่ถูกลบ)')) {
                tables = tables.filter(t => t.id !== id);
                saveLocalData();
                updateStats();
                updateTableList();
                updateAnalytics();
                showSuccessAlert('ลบข้อมูลเรียบร้อยแล้ว');
            }
        }

        // Handle search
        function handleSearch(e) {
            try {
                const searchTerm = e.target.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#tableListBody tr');
                
                rows.forEach(row => {
                    if (!searchTerm) {
                        row.style.display = '';
                        return;
                    }
                    
                    const searchableText = [
                        row.cells[0]?.textContent, // วันที่
                        row.cells[1]?.textContent, // โต๊ะ
                        row.cells[2]?.textContent, // กลุ่มลูกค้า
                        row.cells[4]?.textContent  // ยอดขาย
                    ].join(' ').toLowerCase();
                    
                    row.style.display = searchableText.includes(searchTerm) ? '' : 'none';
                });
            } catch (error) {
                console.error('Error in search:', error);
            }
        }

        // Update analytics
        function updateAnalytics() {
            try {
                if (tables.length === 0) {
                    // Reset all analytics if no data
                    const elements = {
                        avgBillPerTable: document.getElementById('avgBillPerTable'),
                        avgCustomersPerTable: document.getElementById('avgCustomersPerTable'),
                        malePercentage: document.getElementById('malePercentage'),
                        femalePercentage: document.getElementById('femalePercentage'),
                        groupAnalyticsTable: document.getElementById('groupAnalyticsTable')
                    };
                    
                    if (elements.avgBillPerTable) elements.avgBillPerTable.textContent = '0';
                    if (elements.avgCustomersPerTable) elements.avgCustomersPerTable.textContent = '0';
                    if (elements.malePercentage) elements.malePercentage.textContent = '0%';
                    if (elements.femalePercentage) elements.femalePercentage.textContent = '0%';
                    if (elements.groupAnalyticsTable) elements.groupAnalyticsTable.innerHTML = '';
                    return;
                }

                // Calculate key metrics
                const totalBills = tables.reduce((sum, t) => sum + t.totalBill, 0);
                const totalCustomers = tables.reduce((sum, t) => sum + t.customers.length, 0);
                const totalTablesCount = tables.length;

                const allCustomers = tables.flatMap(t => t.customers);
                const maleCount = allCustomers.filter(c => c.gender === 'ชาย').length;
                const femaleCount = allCustomers.filter(c => c.gender === 'หญิง').length;

                const elements = {
                    avgBillPerTable: document.getElementById('avgBillPerTable'),
                    avgCustomersPerTable: document.getElementById('avgCustomersPerTable'),
                    malePercentage: document.getElementById('malePercentage'),
                    femalePercentage: document.getElementById('femalePercentage')
                };

                if (elements.avgBillPerTable) elements.avgBillPerTable.textContent = Math.round(totalBills / totalTablesCount).toLocaleString();
                if (elements.avgCustomersPerTable) elements.avgCustomersPerTable.textContent = (totalCustomers / totalTablesCount).toFixed(1);
                if (elements.malePercentage) elements.malePercentage.textContent = totalCustomers > 0 ? Math.round((maleCount / totalCustomers) * 100) + '%' : '0%';
                if (elements.femalePercentage) elements.femalePercentage.textContent = totalCustomers > 0 ? Math.round((femaleCount / totalCustomers) * 100) + '%' : '0%';

                // Update group analytics
                updateGroupAnalytics();
            } catch (error) {
                console.error('Error updating analytics:', error);
            }
        }

        // Update group analytics
        function updateGroupAnalytics() {
            try {
                const groupStats = {};
                const totalRevenue = tables.reduce((sum, t) => sum + t.totalBill, 0);
                
                tables.forEach(table => {
                    const group = table.customerGroup;
                    if (!groupStats[group]) {
                        groupStats[group] = {
                            tableCount: 0,
                            customerCount: 0,
                            totalRevenue: 0
                        };
                    }
                    
                    groupStats[group].tableCount++;
                    groupStats[group].customerCount += table.customers.length;
                    groupStats[group].totalRevenue += table.totalBill;
                });

                const tbody = document.getElementById('groupAnalyticsTable');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                Object.keys(groupStats).forEach(group => {
                    const stats = groupStats[group];
                    const avgBill = stats.totalRevenue / stats.tableCount;
                    const avgPerHead = stats.totalRevenue / stats.customerCount;
                    const revenuePercent = totalRevenue > 0 ? ((stats.totalRevenue / totalRevenue) * 100).toFixed(1) : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${group}</strong></td>
                        <td>${stats.tableCount}</td>
                        <td>${stats.customerCount}</td>
                        <td>฿${stats.totalRevenue.toLocaleString()}</td>
                        <td>฿${Math.round(avgBill).toLocaleString()}</td>
                        <td>฿${Math.round(avgPerHead).toLocaleString()}</td>
                        <td>${revenuePercent}%</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error updating group analytics:', error);
            }
        }

        // Export to CSV
        function exportToCSV() {
            try {
                if (tables.length === 0) {
                    showErrorAlert('ไม่มีข้อมูลให้ส่งออก');
                    return;
                }

                const headers = [
                    'วันที่เข้าใช้บริการ', 'วันที่บันทึก', 'โต๊ะ', 'กลุ่มลูกค้า', 'จำนวนคน', 'ยอดขายรวม', 'เฉลี่ยต่อหัว',
                    'เวลาเข้าใช้บริการ', 'วิธีชำระเงิน', 'โอกาสพิเศษ', 'ความพึงพอใจ',
                    'เพศลูกค้า', 'อายุลูกค้า', 'ประเภทลูกค้า', 'หมายเหตุ'
                ];

                let csvContent = '\ufeff' + headers.join(',') + '\n';

                tables.forEach(table => {
                    const baseData = [
                        formatDateForCSV(table.visitDate || table.date),
                        formatDateForCSV(table.date),
                        escapeCSV(table.tableNumber),
                        escapeCSV(table.customerGroup),
                        table.customers.length,
                        table.totalBill,
                        Math.round(table.totalBill / table.customers.length),
                        escapeCSV(table.visitTime),
                        escapeCSV(table.paymentMethod),
                        escapeCSV(table.occasion),
                        table.satisfaction || ''
                    ];

                    table.customers.forEach((customer, index) => {
                        const row = [
                            ...baseData,
                            escapeCSV(customer.gender),
                            escapeCSV(customer.age),
                            escapeCSV(customer.type),
                            index === 0 ? escapeCSV(table.notes) : ''
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                });

                downloadCSV(csvContent, `issho_tables_${getCurrentDateString()}.csv`);
                showSuccessAlert('ส่งออกข้อมูล CSV เรียบร้อยแล้ว');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showErrorAlert('เกิดข้อผิดพลาดในการส่งออกข้อมูล');
            }
        }

        // Helper functions
        function escapeCSV(field) {
            if (field === null || field === undefined) return '""';
            const str = String(field);
            if (str.includes('"') || str.includes(',') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return `"${str}"`;
        }

        function formatDateForCSV(date) {
            return new Date(date).toLocaleDateString('th-TH');
        }

        function getCurrentDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize time updates
        setInterval(updateDateTime, 1000);

        // Tab change event listener
        document.addEventListener('shown.bs.tab', function (event) {
            if (event.target.getAttribute('data-bs-target') === '#analytics') {
                setTimeout(() => {
                    updateAnalytics();
                }, 100);
            }
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, ready to start app');
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issho Izakaya - ระบบบันทึกข้อมูลลูกค้า (Google Sheets)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .welcome-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 60px 40px;
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        
        .logo-icon {
            width: 80px;
            height: 80px;
            background: #dc3545;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.3);
        }
        
        .main-app {
            display: none;
            padding: 20px 0;
        }
        
        .navbar-custom {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-custom {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .btn-custom {
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom {
            background: linear-gradient(45deg, #dc3545, #e85a6a);
            border: none;
            color: white;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
            color: white;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }
        
        .form-control:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .customer-card {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .customer-card.filled {
            background: linear-gradient(45deg, #e3f2fd, #f3e5f5);
            border-color: #dc3545;
        }
        
        .remove-customer {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
        }
        
        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            color: #6c757d;
            font-weight: 600;
        }
        
        .nav-tabs .nav-link.active {
            background: #dc3545;
            color: white;
        }
        
        .analytics-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .analytics-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
            font-weight: 500;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .status-online {
            background: #28a745;
            color: white;
        }

        .status-offline {
            background: #ffc107;
            color: #212529;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        .settings-card {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-card">
            <div class="logo-icon">
                <i class="fas fa-utensils text-white" style="font-size: 2rem;"></i>
            </div>
            <h1 class="h2 mb-3" style="color: #dc3545; font-weight: bold;">Issho Izakaya</h1>
            <p class="text-muted mb-4">ระบบบันทึกข้อมูลลูกค้าแบบโต๊ะ<br>เชื่อมต่อกับ Google Sheets</p>
            <button class="btn btn-primary-custom btn-custom" onclick="startApp()">
                <i class="fas fa-play me-2"></i>เริ่มใช้งาน
            </button>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-cloud me-1"></i>
                    ข้อมูลจะถูกบันทึกใน Google Sheets
                </small>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status-offline" style="display: none;">
        <i class="fas fa-wifi me-2"></i>
        <span id="statusText">กำลังเชื่อมต่อ...</span>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light navbar-custom fixed-top">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-utensils text-danger me-2"></i>
                    <strong style="color: #dc3545;">Issho Izakaya</strong>
                </a>
                <div class="d-flex">
                    <span class="navbar-text me-3">
                        <i class="fas fa-calendar-alt me-1"></i>
                        <span id="currentDate"></span>
                    </span>
                    <span class="navbar-text">
                        <i class="fas fa-clock me-1"></i>
                        <span id="currentTime"></span>
                    </span>
                </div>
            </div>
        </nav>

        <div class="container" style="margin-top: 100px;">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Stats Dashboard -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalTables">0</div>
                        <div>โต๊ะทั้งหมด</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalCustomers">0</div>
                        <div>ลูกค้าทั้งหมด</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalRevenue">0</div>
                        <div>ยอดขายรวม (฿)</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="avgPerHead">0</div>
                        <div>เฉลี่ยต่อหัว (฿)</div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="add-table-tab" data-bs-toggle="tab" data-bs-target="#add-table" type="button" role="tab">
                        <i class="fas fa-plus me-2"></i>บันทึกโต๊ะใหม่
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="table-list-tab" data-bs-toggle="tab" data-bs-target="#table-list" type="button" role="tab">
                        <i class="fas fa-list me-2"></i>รายการโต๊ะ
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>วิเคราะห์ข้อมูล
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                        <i class="fas fa-cog me-2"></i>ตั้งค่า
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabContent">
                <!-- Add Table Tab -->
                <div class="tab-pane fade show active" id="add-table" role="tabpanel">
                    <div class="card card-custom">
                        <div class="card-header bg-transparent">
                            <h5 class="mb-0"><i class="fas fa-plus me-2 text-danger"></i>บันทึกข้อมูลโต๊ะใหม่</h5>
                        </div>
                        <div class="card-body">
                            <form id="tableForm">
                                <!-- Table Information -->
                                <div class="row mb-4">
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">วันที่เข้าใช้บริการ *</label>
                                        <input type="date" class="form-control" id="visitDate" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">หมายเลขโต๊ะ</label>
                                        <input type="text" class="form-control" id="tableNumber" placeholder="เช่น T01, A5">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">กลุ่มลูกค้า *</label>
                                        <select class="form-control" id="customerGroup" required>
                                            <option value="">เลือกกลุ่ม</option>
                                            <option value="คนเดียว">คนเดียว</option>
                                            <option value="คู่รัก">คู่รัก</option>
                                            <option value="กลุ่มเพื่อน">กลุ่มเพื่อน</option>
                                            <option value="ครอบครัว">ครอบครัว</option>
                                            <option value="องค์กร/บริษัท">องค์กร/บริษัท</option>
                                            <option value="นักท่องเที่ยว">นักท่องเที่ยว</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">ยอดขายรวม (฿) *</label>
                                        <input type="number" class="form-control" id="totalBill" min="0" step="0.01" required>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">เวลาเข้าใช้บริการ *</label>
                                        <select class="form-control" id="visitTime" required>
                                            <option value="">เลือกช่วงเวลา</option>
                                            <option value="11:00-12:00">11:00-12:00 น.</option>
                                            <option value="12:00-13:00">12:00-13:00 น.</option>
                                            <option value="13:00-14:00">13:00-14:00 น.</option>
                                            <option value="14:00-15:00">14:00-15:00 น.</option>
                                            <option value="15:00-16:00">15:00-16:00 น.</option>
                                            <option value="16:00-17:00">16:00-17:00 น.</option>
                                            <option value="17:00-18:00">17:00-18:00 น.</option>
                                            <option value="18:00-19:00">18:00-19:00 น.</option>
                                            <option value="19:00-20:00">19:00-20:00 น.</option>
                                            <option value="20:00-21:00">20:00-21:00 น.</option>
                                            <option value="21:00-22:00">21:00-22:00 น.</option>
                                            <option value="22:00-23:00">22:00-23:00 น.</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">วิธีการชำระเงิน</label>
                                        <select class="form-control" id="paymentMethod">
                                            <option value="เงินสด">เงินสด</option>
                                            <option value="บัตรเครดิต">บัตรเครดิต</option>
                                            <option value="QR Code">QR Code</option>
                                            <option value="โอนเงิน">โอนเงิน</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">โอกาสพิเศษ</label>
                                        <select class="form-control" id="occasion">
                                            <option value="">เลือกโอกาสพิเศษ</option>
                                            <option value="วันเกิด">วันเกิด</option>
                                            <option value="ครบรอบ">ครบรอบ</option>
                                            <option value="ปาร์ตี้">ปาร์ตี้</option>
                                            <option value="ประชุมงาน">ประชุมงาน</option>
                                            <option value="วันหยุด">วันหยุด</option>
                                            <option value="ทานมื้อเย็น">ทานมื้อเย็น</option>
                                            <option value="นั่งชิล">นั่งชิล</option>
                                            <option value="อื่นๆ">อื่นๆ</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Customer Details -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6><i class="fas fa-users me-2 text-danger"></i>รายละเอียดลูกค้าในโต๊ะ</h6>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCustomer()">
                                        <i class="fas fa-plus me-1"></i>เพิ่มลูกค้า
                                    </button>
                                </div>

                                <div id="customersContainer">
                                    <!-- Customer cards will be added here -->
                                </div>

                                <div class="row mt-4">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">ระดับความพึงพอใจ</label>
                                        <select class="form-control" id="satisfaction">
                                            <option value="">เลือกระดับ</option>
                                            <option value="5">★★★★★ ดีเยี่ยม</option>
                                            <option value="4">★★★★☆ ดี</option>
                                            <option value="3">★★★☆☆ ปานกลาง</option>
                                            <option value="2">★★☆☆☆ พอใช้</option>
                                            <option value="1">★☆☆☆☆ ต้องปรับปรุง</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">หมายเหตุเพิ่มเติม</label>
                                        <textarea class="form-control" id="notes" rows="2" placeholder="ข้อมูลเพิ่มเติม, ปัญหาที่พบ, ข้อเรียกร้องพิเศษ, คำแนะนำจากลูกค้า"></textarea>
                                    </div>
                                </div>

                                <div class="text-end">
                                    <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">
                                        <i class="fas fa-undo me-2"></i>ล้างข้อมูล
                                    </button>
                                    <button type="submit" class="btn btn-primary-custom" id="submitBtn">
                                        <i class="fas fa-save me-2"></i>บันทึกข้อมูล
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Table List Tab -->
                <div class="tab-pane fade" id="table-list" role="tabpanel">
                    <div class="card card-custom">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2 text-danger"></i>รายการโต๊ะ</h5>
                            <div class="d-flex">
                                <button class="btn btn-outline-primary me-2" onclick="loadDataFromSheets()">
                                    <i class="fas fa-sync-alt me-2"></i>โหลดข้อมูลใหม่
                                </button>
                                <input type="text" class="form-control" id="searchTable" placeholder="ค้นหาโต๊ะ..." style="width: 250px;">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>วันที่</th>
                                            <th>โต๊ะ</th>
                                            <th>กลุ่มลูกค้า</th>
                                            <th>จำนวนคน</th>
                                            <th>ยอดขาย</th>
                                            <th>เฉลี่ย/หัว</th>
                                            <th>เวลา</th>
                                            <th>พึงพอใจ</th>
                                            <th>จัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableListBody">
                                        <!-- Table data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-success" onclick="exportToCSV()">
                            <i class="fas fa-download me-2"></i>ส่งออกข้อมูล CSV
                        </button>
                    </div>

                    <!-- Key Metrics -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="analytics-number" id="avgBillPerTable">0</div>
                                <div>เฉลี่ยต่อบิล (฿)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="analytics-number" id="avgCustomersPerTable">0</div>
                                <div>เฉลี่ยคน/โต๊ะ</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="analytics-number" id="malePercentage">0%</div>
                                <div>ลูกค้าชาย</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="analytics-number" id="femalePercentage">0%</div>
                                <div>ลูกค้าหญิง</div>
                            </div>
                        </div>
                    </div>

                    <!-- Group Analytics -->
                    <div class="card card-custom mb-4">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0"><i class="fas fa-chart-pie me-2 text-danger"></i>วิเคราะห์ตามกลุ่มลูก
